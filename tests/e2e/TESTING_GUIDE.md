# E2Eテスト実行ガイド

このガイドでは、Playwright MCPを使用したE2Eテストの実行方法を説明します。

## 事前準備

### 1. 開発環境の起動

E2Eテストを実行する前に、バックエンドとフロントエンドが起動している必要があります。

#### 方法1: Makefileを使用（推奨）

```bash
# プロジェクトルートで実行
make dev
```

これにより、バックエンド（http://localhost:8000）とフロントエンド（http://localhost:5173）が同時に起動します。

#### 方法2: 個別に起動

**ターミナル1: バックエンド起動**
```bash
cd backend
cargo run
```

**ターミナル2: フロントエンド起動**
```bash
cd frontend
npm run dev
```

### 2. 環境確認

開発環境が正しく起動しているか確認します：

- ブラウザで http://localhost:5173 にアクセス
- トップページ（接続設定画面）が表示されることを確認
- ナビゲーションメニューが表示されることを確認

## テスト実行方法

### Claude Codeでのテスト実行

E2Eテストは、Claude Codeを通じてPlaywright MCPツールを使用して実行します。

#### ステップ1: テストファイルを開く

Claude Codeで以下のように指示してください：

```
tests/e2e/scan-page.test.md を読み込んでください
```

#### ステップ2: テストの実行

Claude Codeに以下のように指示してください：

```
このファイルのテストケースを順番に実行してください。
各テストケースの実行結果をチェックボックスで記録してください。
```

Claude Codeは、各テストケースに記載された手順に従って、Playwright MCPツールを使用してブラウザ操作を実行します。

### テストケースの個別実行

特定のテストケースのみを実行したい場合は、Claude Codeに以下のように指示してください：

```
テストケース 3.1.1 から 3.1.3 までを実行してください
```

または

```
3.2 AWSスキャン設定テストをすべて実行してください
```

## テスト実行のコツ

### 1. ブラウザの状態を確認

各テストケースの実行前に、ブラウザスナップショットを取得して現在の状態を確認します。

Claude Codeに以下のように指示してください：

```
現在のページのスナップショットを取得してください
```

### 2. エラーが発生した場合

テスト中にエラーが発生した場合：

1. **ブラウザを閉じる**: `mcp__playwright__browser_close()`
2. **環境を確認**: バックエンド/フロントエンドが起動しているか確認
3. **再実行**: テストケースを最初から再実行

### 3. 長時間実行されるテスト

スキャン実行テスト（3.4）は、実際のAPIを呼び出すため時間がかかる場合があります。

- タイムアウト設定を調整する
- モックAPIを使用する（開発中）

## テスト結果の記録

### チェックボックスの更新

Claude Codeは、各テストケースの実行結果を以下の形式で記録します：

- ✅ 成功
- ❌ 失敗
- ⏭️ スキップ（条件が満たされない場合）

### スクリーンショットの保存

重要なテストケースでは、スクリーンショットを保存することを推奨します：

```
mcp__playwright__browser_take_screenshot({
  filename: "scan-page-aws-initial.png"
})
```

## トラブルシューティング

### 問題: バックエンドに接続できない

**原因**: バックエンドが起動していない、またはポートが異なる

**解決策**:
```bash
# バックエンドが起動しているか確認
lsof -i :8000

# 起動していない場合
cd backend
cargo run
```

### 問題: フロントエンドに接続できない

**原因**: フロントエンドが起動していない、またはポートが異なる

**解決策**:
```bash
# フロントエンドが起動しているか確認
lsof -i :5173

# 起動していない場合
cd frontend
npm run dev
```

### 問題: 要素が見つからない

**原因**: ページが完全に読み込まれていない、またはセレクタが間違っている

**解決策**:
1. `mcp__playwright__browser_wait_for` を使用して要素の表示を待つ
2. `mcp__playwright__browser_snapshot` でページ構造を確認
3. セレクタを修正

### 問題: Azureテストでエラーが発生

**原因**: Azure接続設定がlocalStorageに保存されていない

**解決策**:
1. 接続設定ページ（http://localhost:5173/connection）にアクセス
2. Azureタブを選択
3. 認証方式を選択（Azure CLI または Service Principal）
4. 接続テストを実行して成功させる
5. スキャン設定ページに戻ってテストを再実行

### 問題: スキャン実行テストが失敗

**原因**: 認証情報が設定されていない、または無効

**解決策**:
- AWSの場合: `~/.aws/credentials` にプロファイルが設定されているか確認
- Azureの場合: `az login` でログインしているか確認

## ベストプラクティス

1. **テスト実行前の環境確認**: 必ずバックエンド/フロントエンドが起動していることを確認
2. **順次実行**: テストケースは順番に実行する（並列実行は避ける）
3. **スナップショット活用**: 各ステップでスナップショットを取得し、状態を確認
4. **エラーハンドリング**: エラーが発生したら、ブラウザを閉じて再実行
5. **結果の記録**: 実行結果を必ずテストファイルに記録する

## 参考資料

- [Playwright MCP Documentation](https://github.com/anthropics/anthropic-quickstarts/tree/main/computer-use-demo/mcp-playwright)
- [TODO.md](../../TODO.md) - E2Eテスト実装計画書
- [scan-page.test.md](./scan-page.test.md) - ScanPageテストケース
