# TFKosmos TODOリスト

---

## 📊 テスト実装計画（完了サマリー）

### ✅ Phase 1 & 2: 完了済み

#### バックエンドテスト（完了）
- [x] AWS/Azureスキャナー: 31テスト実装完了
  - [x] AWS scanner: 16テスト（`IamClientOps`トレイト導入）
  - [x] Azure scanner: 15テスト（`AzureClientOps`トレイト導入）
- [x] Terraform生成サービス: 35テスト実装完了
  - [x] generation_service: 15テスト
  - [x] terraform generator: 20テスト
- [x] テンプレート管理: 16テスト実装完了
  - [x] template manager: 7テスト
  - [x] template service: 9テスト
- [x] API統合テスト: 完了
  - [x] connection, scan, generate, templates エンドポイント

#### フロントエンドテスト（完了）
- [x] 状態管理: 42テスト実装完了（AppContext）
- [x] APIクライアント: 47テスト実装完了
  - [x] connection.ts: 11テスト
  - [x] scan.ts: 18テスト
  - [x] resources.ts: 18テスト
- [x] コンポーネント: 124テスト実装完了
  - [x] AwsConnectionForm: 18テスト
  - [x] AzureConnectionForm: 21テスト
  - [x] ScanConfigForm: 23テスト
  - [x] ResourceTable: 23テスト
  - [x] QueryInput: 24テスト
  - [x] TemplatesPage: 15テスト
- [x] ページコンポーネント: 42テスト実装完了
  - [x] ResourcesPage: 22テスト
  - [x] GeneratePage: 20テスト
- [x] テンプレートAPI: 28テスト実装完了
  - [x] templates.ts: 18テスト
  - [x] templates.rs API: 10テスト

**合計**: バックエンド 82テスト、フロントエンド 283テスト

---

## 🚀 Phase 3: E2E & テストインフラ

### E2Eテスト環境構築

#### Playwrightセットアップ
- [x] Playwrightのインストール
  ```bash
  cd frontend
  npm install -D @playwright/test
  npx playwright install
  ```

- [x] `playwright.config.ts` の作成
  - [x] ベースURL設定（http://localhost:5173）
  - [x] ブラウザ設定（chromium, firefox, webkit）
  - [x] タイムアウト設定
  - [x] スクリーンショット設定

- [x] `frontend/e2e/` ディレクトリ構造の作成
  ```
  frontend/e2e/
  ├── fixtures/          # テストデータ
  ├── pages/             # Page Objectパターン
  └── tests/             # テストケース
  ```

#### 基本E2Eテストの実装
- [x] 接続テストフロー
  - [x] AWS接続画面の表示
  - [x] 認証情報入力
  - [x] 接続テスト実行（スキップ: 実際の認証情報が必要）
  - [x] 成功/失敗メッセージの確認

- [x] スキャンフロー
  - [x] スキャン設定画面の表示
  - [x] プロバイダー選択
  - [x] スキャン実行（スキップ: 実際のバックエンドが必要）
  - [x] 進捗表示の確認
  - [x] 結果画面への遷移

### テストインフラの改善

#### カバレッジ測定
- [x] バックエンド: `cargo-llvm-cov` の導入
  ```bash
  cargo install cargo-llvm-cov
  cargo llvm-cov --html
  ```

- [x] フロントエンド: Vitestカバレッジ設定の最適化
  ```bash
  npm run test:coverage
  ```

- [x] カバレッジレポートの生成
  - [x] HTML形式のレポート
  - [x] CI/CD統合
  - [ ] カバレッジバッジの追加（Codecov統合済み）

- [x] Makefileへのカバレッジコマンド追加
  - [x] `make coverage` - 全体カバレッジ
  - [x] `make coverage-backend` - バックエンドのみ
  - [x] `make coverage-frontend` - フロントエンドのみ
  - [x] `make coverage-report` - レポートを開く

#### CI/CDパイプライン
- [x] GitHub Actionsワークフローの作成
  - [x] バックエンドテストの自動実行（`.github/workflows/test.yml`）
  - [x] フロントエンドテストの自動実行（`.github/workflows/test.yml`）
  - [x] E2Eテストの自動実行（`.github/workflows/test.yml`）
  - [x] カバレッジレポートの生成とアップロード（Codecov）

- [x] Lint/フォーマットチェックワークフロー（`.github/workflows/lint.yml`）
  - [x] Rust: `cargo fmt` + `cargo clippy`
  - [x] TypeScript: ESLint + Type check

- [x] テスト実行の最適化
  - [x] 並列実行の設定（ジョブ分離）
  - [x] キャッシュの活用（Cargo, npm）
  - [x] Makefileへのテストコマンド追加

#### テストデータ管理
- [x] フィクスチャの整備
  - [x] バックエンド: テストデータJSON（`src/test_helpers/fixtures.rs`）
  - [x] フロントエンド: モックデータ（`src/test/mock-data.ts`）
  - [x] E2E: シードデータ（`e2e/fixtures/test-data.ts`）

- [x] テストヘルパーの作成
  - [x] バックエンド: モックビルダー（`src/test_helpers/builders.rs`）
  - [x] フロントエンド: カスタムレンダラー（`src/test/test-utils.tsx`）
  - [x] E2E: Page Objectパターン（`e2e/pages/`）

### 完全なE2Eテストスイート

#### エンドツーエンドシナリオ
- [x] AWS完全フロー
  - [x] AWS接続 → スキャン → リソース選択 → Terraform生成 → ダウンロード
  - [x] AWS接続 → スキャン → 依存関係グラフ表示
  - [x] AWS接続 → スキャン → フィルタリング → リソース選択
  - テストファイル: `frontend/e2e/tests/aws-full-flow.test.ts`

- [x] Azure完全フロー
  - [x] Azure接続 → スキャン → リソース選択 → Terraform生成 → ダウンロード
  - [x] Azure接続 → スキャン → 依存関係グラフ表示
  - [x] Azure接続 → スキャン → フィルタリング → リソース選択
  - [x] Azure接続 → スキャン → ページネーション
  - テストファイル: `frontend/e2e/tests/azure-full-flow.test.ts`

- [x] テンプレートカスタマイズフロー
  - [x] テンプレート選択とエディタ表示
  - [x] テンプレート編集 → 検証 → 保存
  - [x] テンプレート編集 → プレビュー
  - [x] テンプレートカスタマイズ → デフォルトに復元
  - [x] 無効なテンプレート構文でバリデーションエラー
  - [x] 複数のテンプレート編集
  - [x] テンプレート切り替え時のコンテンツ更新
  - テストファイル: `frontend/e2e/tests/template-flow.test.ts`

#### エッジケースとエラーシナリオ
- [x] 認証エラーのテスト
  - [x] AWS: 無効なプロファイル
  - [x] Azure: 無効なTenant ID
  - [x] Azure: 無効なClient Secret
- [x] ネットワークエラーのテスト
  - [x] バックエンドサーバー停止時のエラー
- [x] タイムアウトのテスト
  - [x] APIタイムアウトシナリオ
- [x] 不正な入力のテスト
  - [x] AWS: プロファイル未入力
  - [x] Azure: サブスクリプション未選択
  - [x] 無効な出力パス
  - [x] 空のテンプレート保存
- [x] 大量データの処理テスト
  - [x] スキャン結果ゼロ件の場合
  - [x] 大量リソースのページネーション
  - [x] 非常に大きなテンプレート
- [x] UI操作のエッジケース
  - [x] 複数タブの高速切り替え
  - [x] リソース選択の連続操作
  - [x] フィルター適用中のタブ切り替え
- [x] 生成エラーシナリオ
  - [x] リソース選択なしで生成実行
  - [x] 生成中に複数回生成ボタンをクリック
- [x] ブラウザバック/フォワード操作
  - [x] スキャン完了後のブラウザバック
  - [x] 生成完了後のブラウザバック
- [x] セッション・状態管理
  - [x] ページリロード後の選択状態保持
  - [x] 長時間アイドル後の操作
- テストファイル: `frontend/e2e/tests/edge-cases.test.ts`

#### Page Objects実装
- [x] `frontend/e2e/pages/BasePage.ts` - ベースページクラス
- [x] `frontend/e2e/pages/ConnectionPage.ts` - 接続ページ
- [x] `frontend/e2e/pages/ScanPage.ts` - スキャンページ
- [x] `frontend/e2e/pages/ResourcesPage.ts` - リソースページ（新規作成）
- [x] `frontend/e2e/pages/GeneratePage.ts` - 生成ページ（新規作成）
- [x] `frontend/e2e/pages/TemplatesPage.ts` - テンプレートページ（新規作成）

**注意**: 多くのE2Eテストは実際のクラウド認証情報とバックエンドサーバーが必要なため、デフォルトではスキップされています。
ローカル環境で実行する場合は、`.skip()`を削除し、有効な認証情報を設定してください。

---

## 🎯 Phase 4: 機能追加計画

### リソースタイプ拡張

#### AWSリソース追加
- [ ] EC2インスタンス
  - [ ] スキャン機能
  - [ ] Terraform生成
  - [ ] インポート対応

- [ ] VPCリソース
  - [ ] VPC、サブネット
  - [ ] ルートテーブル
  - [ ] セキュリティグループ
  - [ ] NACLs

- [ ] RDS
  - [ ] DBインスタンス
  - [ ] DBサブネットグループ
  - [ ] パラメータグループ

- [ ] S3
  - [ ] バケット
  - [ ] バケットポリシー
  - [ ] ライフサイクル設定

#### Azureリソース追加
- [ ] 仮想マシン
- [ ] 仮想ネットワーク
- [ ] NSG
- [ ] ストレージアカウント
- [ ] SQLデータベース

### 高度な機能

#### 差分検出機能
- [ ] 既存Terraformコードの読み込み
- [ ] スキャン結果との差分比較
- [ ] 差分レポート生成
- [ ] 差分の可視化（UI）

#### 設定管理
- [ ] スキャン設定のインポート/エクスポート
  - [ ] JSON/YAML形式での保存
  - [ ] 設定テンプレート
  - [ ] 設定の共有

- [ ] プロジェクト管理
  - [ ] 複数プロジェクトの管理
  - [ ] プロジェクト間の切り替え
  - [ ] プロジェクト設定の永続化

#### バッチ処理
- [ ] 複数アカウント/サブスクリプションの一括スキャン
- [ ] スケジュールスキャン
- [ ] バッチレポート生成

#### CLIサポート
- [ ] コマンドラインインターフェースの実装
  - [ ] `tfkosmos scan` コマンド
  - [ ] `tfkosmos generate` コマンド
  - [ ] 設定ファイルサポート
  - [ ] パイプライン統合

#### Terraform統合
- [ ] Terraform Cloud統合
  - [ ] ワークスペース連携
  - [ ] State管理
  - [ ] リモート実行

- [ ] Terraform Enterprise統合
  - [ ] 組織管理
  - [ ] チーム権限

### UI/UX改善

#### ダッシュボード
- [ ] スキャン履歴の表示
- [ ] リソース統計の可視化

#### 検索・フィルタ機能強化
- [ ] 高度な検索クエリ
- [ ] 保存された検索条件
- [ ] タグベースのフィルタリング

#### エクスポート機能
- [ ] CSVエクスポート
- [ ] JSONエクスポート

---

## 🔧 Phase 5: 全体レビュー&リファクタリング計画

### コードベース全体レビュー

#### アーキテクチャレビュー
- [x] 現在のアーキテクチャの文書化
  - [x] システム構成図の作成
  - [x] データフロー図の作成（`docs/02_設計仕様/データフロー図.md`）
  - [x] アーキテクチャ決定記録（ADR）の作成（`docs/02_設計仕様/ADR/`）

- [x] アーキテクチャの評価
  - [x] スケーラビリティの検証
  - [x] 保守性の評価
  - [x] 拡張性の確認

- [x] 改善提案の作成
  - [x] ボトルネックの特定
  - [x] 改善案の文書化（`docs/02_設計仕様/アーキテクチャ評価と改善提案.md`）
  - [x] 優先順位付け

#### コード品質レビュー
- [x] バックエンド（Rust）
  - [x] Clippyによる静的解析（警告なし）
  - [x] コーディング規約の準拠確認（フォーマット適合）
  - [x] 未使用コードの削除（不要なし）
  - [ ] ドキュメントコメントの充実（改善推奨）

- [x] フロントエンド（TypeScript/React）
  - [x] ESLintによる静的解析（any型警告約50件、エラーなし）
  - [ ] 型安全性の向上（any型の排除推奨）
  - [x] コンポーネント設計のレビュー
  - [ ] アクセシビリティの改善（改善推奨）

**レビュー結果**: `docs/04_品質管理/コード品質レビュー結果.md`

### パフォーマンス最適化

#### バックエンド最適化
- [x] スキャン処理の高速化
  - [x] スキャン済みデータの再利用（`scan_attachments_with_data`）
  - [x] タグ取得オプション化（`include_tags`パラメータ追加）
  - [x] 不要なAPI呼び出しの削減

- [ ] Terraform生成の最適化
  - [ ] テンプレートレンダリングの高速化
  - [ ] ファイルI/Oの最適化
  - [ ] メモリ使用量の削減

- [x] API応答時間の改善
  - [x] Server-Sent Events (SSE) によるストリーミングスキャン
    - `/api/scan/aws/stream` と `/api/scan/azure/stream` エンドポイント追加
    - リアルタイム進捗通知（progress, resource, completed, error イベント）
  - [x] 非同期処理の活用（チャネルベースのストリーミング）
  - [ ] データベースクエリの最適化（将来的に導入する場合）

#### フロントエンド最適化
- [ ] バンドルサイズの削減
  - [ ] コード分割の実装
  - [ ] 遅延ロード（Lazy loading）
  - [ ] Tree shaking の最適化

- [ ] レンダリングパフォーマンス
  - [ ] React.memoの活用
  - [ ] useCallbackの適切な使用
  - [ ] 仮想スクロールの導入（大量データ表示時）

- [ ] ネットワーク最適化
  - [ ] APIリクエストのバッチング
  - [ ] キャッシング戦略
  - [ ] Progressive Web App（PWA）対応

### エラーハンドリングとログ強化

#### エラーハンドリング改善
- [ ] バックエンド
  - [ ] エラー型の統一化
  - [ ] コンテキスト情報の充実
  - [ ] リトライロジックの実装
  - [ ] グレースフルデグラデーション

- [ ] フロントエンド
  - [ ] エラーバウンダリの実装
  - [ ] ユーザーフレンドリーなエラーメッセージ
  - [ ] エラー復旧機能
  - [ ] オフライン対応

#### ログ機能の強化
- [ ] 構造化ログの導入
  - [ ] JSON形式のログ出力
  - [ ] ログレベルの適切な使い分け
  - [ ] コンテキスト情報の付加

- [ ] ログ管理
  - [ ] ログローテーション
  - [ ] ログの集約（将来的に）
  - [ ] ログ分析ツールの導入検討

- [ ] モニタリング
  - [ ] メトリクス収集
  - [ ] アラート設定
  - [ ] ダッシュボード作成

### セキュリティ監査

#### セキュリティレビュー
- [ ] 認証・認証情報管理
  - [ ] 認証情報の安全な保存方法の再検討
  - [ ] セッション管理の改善
  - [ ] トークンの有効期限管理

- [ ] 入力バリデーション
  - [ ] すべての入力ポイントのバリデーション
  - [ ] SQLインジェクション対策（将来的にDB導入時）
  - [ ] XSS対策の確認

- [ ] 依存関係の監査
  - [ ] 脆弱性スキャン（npm audit, cargo audit）
  - [ ] 定期的な依存関係の更新
  - [ ] ライセンスコンプライアンスの確認

#### セキュリティ機能追加
- [ ] レート制限の実装
- [ ] CORS設定の見直し
- [ ] Content Security Policy（CSP）の実装
- [ ] セキュリティヘッダーの追加

### ドキュメント整備

#### ユーザードキュメント
- [ ] ユーザーガイドの作成
  - [ ] インストール手順
  - [ ] 基本的な使い方
  - [ ] トラブルシューティング
  - [ ] FAQ

- [ ] チュートリアル
  - [ ] AWS IAMのスキャンと生成
  - [ ] Azure IAMのスキャンと生成
  - [ ] カスタムテンプレートの作成

- [ ] API ドキュメント
  - [ ] OpenAPI仕様書の作成
  - [ ] エンドポイント一覧
  - [ ] リクエスト/レスポンス例

#### 開発者ドキュメント
- [ ] コントリビューションガイド
  - [ ] 開発環境のセットアップ
  - [ ] コーディング規約
  - [ ] プルリクエストのガイドライン

- [ ] アーキテクチャドキュメント
  - [ ] システム設計の詳細
  - [ ] データモデル
  - [ ] API設計

- [ ] デプロイガイド
  - [ ] ビルド手順
  - [ ] リリースプロセス
  - [ ] 環境設定

### 技術的負債の解消

#### リファクタリング優先リスト
- [ ] 重複コードの削除
  - [ ] 共通処理の抽出
  - [ ] ユーティリティ関数の整理
  - [ ] コンポーネントの再利用性向上

- [ ] 命名の改善
  - [ ] 一貫性のない命名の修正
  - [ ] 分かりやすい名前への変更
  - [ ] 略語の統一

- [ ] 複雑度の削減
  - [ ] 長い関数の分割
  - [ ] ネストの削減
  - [ ] 条件分岐の簡素化

#### 依存関係の整理
- [ ] 未使用の依存関係の削除
- [ ] 依存関係の最新化
- [ ] 脆弱性のある依存関係の更新
- [ ] ライセンスの確認と整理

#### テストカバレッジの向上
- [ ] カバレッジの低い箇所の特定
- [ ] 追加テストの作成
- [ ] テストの品質向上
- [ ] テストの保守性改善

### リリース準備

#### バージョニング戦略
- [ ] セマンティックバージョニングの採用
- [ ] CHANGELOGの作成
- [ ] リリースノートの作成

#### CI/CD強化
- [ ] 自動リリースフローの構築
- [ ] ビルド最適化
- [ ] デプロイメント自動化

#### パッケージング
- [ ] Tauriアプリのインストーラー改善
  - [ ] macOS: .dmg, .app の最適化
  - [ ] Windows: .msi の署名
  - [ ] 自動更新機能の実装

---

## 📈 カバレッジ目標

### 短期目標（Phase 1&2 完了時）✅
- [x] バックエンド: 50% → 70% 達成
- [x] フロントエンド: 24% → 50% 達成

### 中期目標（Phase 3 完了時）
- [ ] バックエンド: 70% → 80%
- [ ] フロントエンド: 50% → 70%
- [ ] E2E: 基本フロー → 全主要フロー

### 長期目標（Phase 4&5 完了時）
- [ ] バックエンド: 80%+
- [ ] フロントエンド: 70%+
- [ ] E2E: 全フロー + エッジケース
- [ ] CI/CD完全自動化
- [ ] カバレッジレポート自動生成

---

## 🔧 開発環境セットアップ

### テスト実行コマンド

#### バックエンド
```bash
# 全テスト実行
cargo test

# 特定のテスト実行
cargo test connection_service

# カバレッジ測定
cargo tarpaulin --out Html

# ウォッチモード
cargo watch -x test
```

#### フロントエンド
```bash
# 全テスト実行
npm run test:run

# ウォッチモード
npm run test

# カバレッジ測定
npm run test:coverage

# 特定のテスト実行
npm run test:run -- src/api/client.test.ts
```

#### E2E
```bash
# E2Eテスト実行
npx playwright test

# UIモード（デバッグ用）
npx playwright test --ui

# 特定のブラウザ
npx playwright test --project=chromium
```

---

## 📝 テスト作成のガイドライン

### バックエンド（Rust）
- `#[cfg(test)]` モジュールを使用
- `#[tokio::test]` で非同期テスト
- Arrange-Act-Assert パターン
- モックには `mockall` クレートを使用
- テスト名は `test_<function>_<scenario>` 形式

### フロントエンド（TypeScript/React）
- `vitest` と `@testing-library/react` を使用
- コンポーネントは `render()` でマウント
- `userEvent` でユーザー操作をシミュレート
- `waitFor()` で非同期処理を待機
- `vi.mock()` でモジュールをモック

### E2E（Playwright）
- Page Objectパターンを使用
- テストは独立して実行可能に
- `test.describe()` でグループ化
- `test.beforeEach()` でセットアップ
- スクリーンショットでデバッグ
