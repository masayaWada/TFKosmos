---
description: Testing guidelines and requirements
paths: "**/*.{test,spec}.{ts,tsx,rs}"
---

# テストコード作成時の厳守事項

以下を必ず厳守すること

## テストコードの品質

- テストは必ず実際の機能を検証すること
- `expect(true).toBe(true)` のような意味のないアサーションは絶対に書かない
- 各テストケースは具体的な入力と期待される出力を検証すること
- モックは必要最低限に留め、実際の操作に近い形でテストすること

## ハードコーディングの禁止

- テストを通すためだけのハードコードは絶対に禁止
- 本番コードに `if(testMode)` のような条件分岐を入れない
- テスト用の特別な値（マジックナンバー）を本番コードに埋め込まない
- 環境変数や設定ファイルを使用して、テスト環境と本番環境を適切に分離すること

## テスト実装の原則

- テストが失敗する状態から始めること（Red-Green-Refactor）
- 境界値、異常系、エラーケースも必ずテストすること
- カバレッジだけでなく、実際の品質を重視すること
- テストケース名は何をテストしているか明確に記述すること

## 実装前の確認

- 機能の使用を正しく理解してからテストを書くこと
- 不明な点があれば、仮の実装ではなく、ユーザーに確認すること

## テストの独立性と再現性

- 各テストは他のテストに依存しないこと（実行順序に依存しない）
- テストは何度実行しても同じ結果になること（冪等性）
- 外部サービス（API、データベース、ファイルシステム）への依存は適切にモック化すること
- 日時やランダム値に依存するテストは、値を固定して再現性を確保すること

## テストデータの管理

- テストデータはテスト内で明示的に作成し、テスト後にクリーンアップすること
- テスト間で共有状態を持たないこと（グローバル変数の変更を避ける）
- 大量のテストデータが必要な場合は、ファクトリー関数やビルダーパターンを使用すること

## モックとスタブの適切な使用

- モックは外部依存（API呼び出し、DB操作）に対してのみ使用すること
- 内部実装の詳細をモックしすぎないこと（リファクタリング耐性が下がる）
- モックの振る舞いが本番環境と乖離しないよう注意すること
- スパイを使用する場合は、テスト後に必ずリストアすること

## 非同期処理のテスト

- 非同期テストでは必ず適切に `await` すること
- タイムアウトは明示的に設定し、テストが無限に待機しないようにすること
- `setTimeout` や `setInterval` を使用するコードは、タイマーモックを使用すること
- Promise の reject ケースも必ずテストすること

## テストの保守性

- テストコードもプロダクションコードと同様に可読性を重視すること
- 過度なDRYよりも、各テストの意図が明確に分かることを優先すること
- テストが失敗した際に、原因が特定しやすいアサーションメッセージを記述すること
- Arrange-Act-Assert（AAA）パターンでテストを構造化すること

## スナップショットテストの注意点

- スナップショットの差分は必ず目視で確認してから更新すること
- 意図しない変更を安易に `--update` で上書きしないこと
- 大きすぎるスナップショットは避け、必要な部分のみをテストすること

## テストファイルの配置

- テストファイルは対象ファイルと同じディレクトリに配置すること（コロケーション）
- ファイル名は `{対象ファイル名}.test.{ts,tsx}` の形式にすること
- 共通のテストユーティリティは `src/test/` ディレクトリに配置すること
