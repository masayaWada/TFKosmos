# 2. データモデル

> **注意**: ドメインモデルは `serde_json::Value` を使用して柔軟性を確保しています。以下はJSONデータ構造の概念的な表現と、明示的に定義されたRust構造体を示しています。

### 2.1 AWS IAM ドメインモデル（JSON構造）

#### IAMUser

```json
{
  "user_name": "string",
  "user_id": "string",
  "arn": "string",
  "path": "string",
  "create_date": "datetime",
  "tags": { "key": "value" },
  "attached_policies": ["arn:aws:iam::..."],
  "inline_policies": [{ "policy_name": "...", "policy_document": {} }],
  "groups": ["group_name"],
  "access_keys": [{ "access_key_id": "...", "status": "Active" }],
  "login_profile": { "user_name": "...", "password_reset_required": true },
  "mfa_devices": [{ "serial_number": "...", "device_type": "virtual" }]
}
```

#### IAMGroup

```json
{
  "group_name": "string",
  "group_id": "string",
  "arn": "string",
  "path": "string",
  "create_date": "datetime",
  "tags": { "key": "value" },
  "attached_policies": ["arn:aws:iam::..."],
  "inline_policies": [{ "policy_name": "...", "policy_document": {} }],
  "members": ["user_name"]
}
```

#### IAMRole

```json
{
  "role_name": "string",
  "role_id": "string",
  "arn": "string",
  "path": "string",
  "assume_role_policy_document": {},
  "create_date": "datetime",
  "tags": { "key": "value" },
  "attached_policies": ["arn:aws:iam::..."],
  "inline_policies": [{ "policy_name": "...", "policy_document": {} }],
  "instance_profiles": ["profile_name"]
}
```

#### IAMPolicy (カスタム)

```json
{
  "policy_name": "string",
  "policy_id": "string",
  "arn": "string",
  "path": "string",
  "default_version_id": "string",
  "policy_document": {},
  "create_date": "datetime",
  "update_date": "datetime",
  "tags": { "key": "value" },
  "attachment_count": 0
}
```

#### PolicyAttachment

```json
{
  "policy_arn": "string",
  "target_type": "user | group | role",
  "target_name": "string",
  "attachment_id": "string"
}
```

#### GroupMembership

```json
{
  "group_name": "string",
  "user_name": "string",
  "membership_id": "string"
}
```

#### AccessKey (Cleanup用)

```json
{
  "access_key_id": "string",
  "user_name": "string",
  "status": "Active | Inactive",
  "create_date": "datetime"
}
```

> **注意**: `secret_access_key` は取得しません（セキュリティ上の理由）

#### LoginProfile (Cleanup用)

```json
{
  "user_name": "string",
  "password_reset_required": true,
  "create_date": "datetime"
}
```

> **注意**: `password` は取得しません（セキュリティ上の理由）

#### MFADevice (Cleanup用)

```json
{
  "serial_number": "string",
  "user_name": "string",
  "device_type": "virtual | hardware",
  "enable_date": "datetime"
}
```

> **注意**: `seed` は取得しません（セキュリティ上の理由）

### 2.2 Azure IAM ドメインモデル（JSON構造）

#### AzureRoleDefinition

```json
{
  "role_definition_id": "string",
  "name": "string",
  "role_name": "string",
  "description": "string",
  "role_type": "CustomRole",
  "assignable_scopes": ["scope1", "scope2"],
  "permissions": [
    {
      "actions": ["*"],
      "not_actions": [],
      "data_actions": [],
      "not_data_actions": []
    }
  ],
  "subscription_id": "string",
  "scope": "string"
}
```

#### AzureRoleAssignment

```json
{
  "assignment_id": "string",
  "role_definition_id": "string",
  "role_definition_name": "string",
  "principal_id": "string",
  "principal_type": "User | ServicePrincipal | Group",
  "scope": "string",
  "subscription_id": "string"
}
```

### 2.3 スキャン設定モデル

#### ScanConfig (Rust構造体)

```rust
use serde::{Deserialize, Serialize};
use std::collections::HashMap;

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ScanConfig {
    pub provider: String, // "aws" or "azure"

    // AWS specific
    #[serde(skip_serializing_if = "Option::is_none")]
    pub account_id: Option<String>,
    #[serde(skip_serializing_if = "Option::is_none")]
    pub profile: Option<String>,
    #[serde(skip_serializing_if = "Option::is_none")]
    pub assume_role_arn: Option<String>,
    #[serde(skip_serializing_if = "Option::is_none")]
    pub assume_role_session_name: Option<String>,

    // Azure specific
    #[serde(skip_serializing_if = "Option::is_none")]
    pub subscription_id: Option<String>,
    #[serde(skip_serializing_if = "Option::is_none")]
    pub tenant_id: Option<String>,
    #[serde(skip_serializing_if = "Option::is_none")]
    pub auth_method: Option<String>, // "az_login", "service_principal"
    #[serde(skip_serializing_if = "Option::is_none")]
    pub service_principal_config: Option<HashMap<String, String>>,
    #[serde(skip_serializing_if = "Option::is_none")]
    pub scope_type: Option<String>, // "management_group", "subscription", "resource_group"
    #[serde(skip_serializing_if = "Option::is_none")]
    pub scope_value: Option<String>,

    // Common
    #[serde(default)]
    pub scan_targets: HashMap<String, bool>,
    #[serde(default)]
    pub filters: HashMap<String, String>,
}
```

### 2.4 生成設定モデル

#### GenerationConfig (Rust構造体)

```rust
use serde::{Deserialize, Serialize};
use std::collections::HashMap;

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct GenerationConfig {
    pub output_path: String,
    #[serde(default = "default_file_split_rule")]
    pub file_split_rule: String, // "single", "by_resource_type", "by_resource_name"
    #[serde(default = "default_naming_convention")]
    pub naming_convention: String, // "snake_case", "kebab-case", "original"
    #[serde(default = "default_import_script_format")]
    pub import_script_format: String, // "sh", "ps1"
    #[serde(default = "default_true")]
    pub generate_readme: bool,
    #[serde(default)]
    pub selected_resources: HashMap<String, Vec<serde_json::Value>>,
}

fn default_file_split_rule() -> String {
    "single".to_string()
}

fn default_naming_convention() -> String {
    "snake_case".to_string()
}

fn default_import_script_format() -> String {
    "sh".to_string()
}

fn default_true() -> bool {
    true
}
```

### 2.5 レスポンスモデル

#### ScanResponse

```rust
use serde::{Deserialize, Serialize};
use std::collections::HashMap;

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ScanResponse {
    pub scan_id: String,
    pub status: String,
    #[serde(skip_serializing_if = "Option::is_none")]
    pub progress: Option<u32>,
    #[serde(skip_serializing_if = "Option::is_none")]
    pub message: Option<String>,
    #[serde(skip_serializing_if = "Option::is_none")]
    pub summary: Option<HashMap<String, usize>>,
}
```

#### GenerationResponse

```rust
use serde::{Deserialize, Serialize};
use std::collections::HashMap;

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct GenerationResponse {
    pub generation_id: String,
    pub output_path: String,
    pub files: Vec<String>,
    pub import_script_path: Option<String>,
    #[serde(skip_serializing_if = "Option::is_none")]
    pub preview: Option<HashMap<String, String>>,
}
```

#### ConnectionTestResponse

```rust
use serde::{Deserialize, Serialize};

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ConnectionTestResponse {
    pub success: bool,
    #[serde(skip_serializing_if = "Option::is_none")]
    pub message: Option<String>,
    #[serde(skip_serializing_if = "Option::is_none")]
    pub account_id: Option<String>,
    #[serde(skip_serializing_if = "Option::is_none")]
    pub user_arn: Option<String>,
    #[serde(skip_serializing_if = "Option::is_none")]
    pub subscription_name: Option<String>, // Azure用
}
```

---
