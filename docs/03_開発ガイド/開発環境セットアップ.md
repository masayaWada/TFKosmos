# 開発環境セットアップ

## 1. 概要

このドキュメントでは、TFKosmosの開発環境セットアップ、実行方法、環境変数設定、テスト、デプロイについて説明します。

---

## 2. 開発環境セットアップ

### 必要なツール

- **Rust**: 1.70以上
- **Node.js**: 18以上
- **npm**: 9以上

### インストール手順

```bash
# Rustのインストール（未インストールの場合）
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
# または https://rustup.rs/ からインストール

# Rustのバージョン確認
rustc --version

# 注意: cargoコマンドが見つからない場合、以下を実行してください
# source ~/.cargo/env

# Backend（依存関係は初回ビルド時に自動インストール）
cd backend
cargo build

# Frontend
cd frontend
npm install
```

**注意**: 新しいターミナルセッションでは、`source ~/.cargo/env`を実行するか、シェルの設定ファイル（`.zshrc`や`.bashrc`）に以下を追加してください：

```bash
source "$HOME/.cargo/env"
```

---

## 3. 実行方法

### 方法1: 同時起動（推奨）

フロントエンドとバックエンドを同時に起動：

```bash
# Makefileを使用（推奨）
make dev

# またはシェルスクリプトを使用
./dev.sh

# またはCursor/VS Codeのタスクを使用
# Cmd+Shift+P → "Tasks: Run Task" → "dev: フロントエンド + バックエンド"
```

### 方法2: 個別に起動

```bash
# 注意: cargoコマンドが見つからない場合、先に以下を実行してください
# source ~/.cargo/env

# Backend起動（開発モード）
cd backend
cargo run

# Backend起動（リリースモード、最適化済み）
cd backend
cargo run --release

# Frontend起動
cd frontend
npm run dev
```

**起動後のURL:**

- バックエンド: `http://0.0.0.0:8000`
- フロントエンド: `http://localhost:5173`

---

## 4. 環境変数

TFKosmosは環境変数を使用してアプリケーションの動作をカスタマイズできます。すべての環境変数は `TFKOSMOS_` プレフィックスで統一されています。

### 4.1 バックエンド環境変数

| 変数名 | 説明 | デフォルト値 | 必須 |
|--------|------|-------------|-----|
| `TFKOSMOS_ENV` | 実行環境（`development` / `production`） | `development` | × |
| `TFKOSMOS_HOST` | サーバーがリッスンするホスト | `0.0.0.0` | × |
| `TFKOSMOS_PORT` | サーバーがリッスンするポート | `8000` | × |
| `TFKOSMOS_CORS_ORIGINS` | CORS許可オリジン（カンマ区切り） | 空（開発時は全許可） | × |

### 4.2 AWS関連（システム環境変数）

| 変数名 | 説明 | 設定方法 |
|--------|------|---------|
| `AWS_PROFILE` | 使用するAWSプロファイル | `~/.aws/credentials`で定義 |
| `AWS_DEFAULT_REGION` | デフォルトリージョン | 通常は`ap-northeast-1`等 |
| `AWS_ACCESS_KEY_ID` | アクセスキーID | 直接指定（非推奨） |
| `AWS_SECRET_ACCESS_KEY` | シークレットアクセスキー | 直接指定（非推奨） |

### 4.3 Azure関連（システム環境変数）

| 変数名 | 説明 | 設定方法 |
|--------|------|---------|
| `AZURE_TENANT_ID` | AzureテナントID | サービスプリンシパル使用時 |
| `AZURE_CLIENT_ID` | AzureクライアントID | サービスプリンシパル使用時 |
| `AZURE_CLIENT_SECRET` | Azureクライアントシークレット | サービスプリンシパル使用時 |
| `AZURE_SUBSCRIPTION_ID` | AzureサブスクリプションID | スキャン対象指定 |

### 4.4 環境変数の詳細

#### TFKOSMOS_ENV

実行環境を指定します。環境によってCORS設定やログ出力レベルが変わります。

| 値 | 説明 |
|-----|------|
| `development` | 開発環境。CORS全許可、詳細ログ出力 |
| `production` | 本番環境。CORS制限、最小限のログ出力 |

```bash
# 開発環境（デフォルト）
export TFKOSMOS_ENV=development

# 本番環境
export TFKOSMOS_ENV=production
```

#### TFKOSMOS_HOST

サーバーがリッスンするホストアドレスを指定します。

| 値 | 説明 | 用途 |
|-----|------|-----|
| `0.0.0.0` | すべてのネットワークインターフェース | 開発環境、Docker |
| `127.0.0.1` | ローカルホストのみ | 本番環境（セキュリティ強化） |
| `localhost` | ローカルホストのみ | 本番環境 |

```bash
# 外部からのアクセスを許可（開発環境）
export TFKOSMOS_HOST=0.0.0.0

# ローカルのみ許可（本番環境）
export TFKOSMOS_HOST=127.0.0.1
```

#### TFKOSMOS_PORT

サーバーがリッスンするポート番号を指定します。

```bash
# デフォルト
export TFKOSMOS_PORT=8000

# カスタムポート
export TFKOSMOS_PORT=3000
```

#### TFKOSMOS_CORS_ORIGINS

Cross-Origin Resource Sharing (CORS) で許可するオリジンをカンマ区切りで指定します。

```bash
# 単一オリジン
export TFKOSMOS_CORS_ORIGINS=http://localhost:5173

# 複数オリジン
export TFKOSMOS_CORS_ORIGINS=http://localhost:5173,tauri://localhost,https://myapp.example.com

# 開発環境で空の場合は全オリジン許可
unset TFKOSMOS_CORS_ORIGINS
```

### 4.5 開発環境 vs 本番環境

#### 開発環境設定

```bash
# .env.development
TFKOSMOS_ENV=development
TFKOSMOS_HOST=0.0.0.0
TFKOSMOS_PORT=8000
# CORS_ORIGINS未設定 = 全オリジン許可
```

**特徴:**

- CORS: すべてのオリジンからのリクエストを許可
- ログ: 詳細なデバッグログを出力
- ホスト: 外部からのアクセスを許可（チーム開発用）

#### 本番環境設定

```bash
# .env.production
TFKOSMOS_ENV=production
TFKOSMOS_HOST=127.0.0.1
TFKOSMOS_PORT=8000
TFKOSMOS_CORS_ORIGINS=tauri://localhost
```

**特徴:**

- CORS: 指定されたオリジンのみ許可
- ログ: 最小限のログ出力
- ホスト: ローカルからのアクセスのみ許可

### 4.6 設定の適用方法

#### 方法1: コマンドライン引数

```bash
# 一時的に環境変数を設定して実行
TFKOSMOS_ENV=production TFKOSMOS_PORT=3000 cargo run
```

#### 方法2: シェル設定ファイル

```bash
# ~/.zshrc または ~/.bashrc に追加
export TFKOSMOS_ENV=development
export TFKOSMOS_PORT=8000
```

#### 方法3: .envファイル

```bash
# プロジェクトルートに .env ファイルを作成
# 注意: dotenvクレート未導入のため、シェルで読み込む必要があります

# .env ファイルの内容
TFKOSMOS_ENV=development
TFKOSMOS_HOST=0.0.0.0
TFKOSMOS_PORT=8000

# 読み込んで実行
export $(cat .env | xargs) && cd backend && cargo run
```

#### 方法4: Makefileタスク

```bash
# Makefileで環境変数を設定
make dev          # 開発環境で起動
```

### 4.7 設定の確認

#### バックエンドログで確認

サーバー起動時に設定がログ出力されます：

```text
INFO  Environment: Development
INFO  Server listening on 0.0.0.0:8000
INFO  CORS: All origins allowed (development mode)
```

#### APIエンドポイントで確認（将来実装予定）

```bash
# 設定確認エンドポイント（開発環境のみ）
curl http://localhost:8000/api/config
```

---

## 5. テストコマンド

### 5.1 バックエンド（Rust）

```bash
cd backend

# 全テスト実行
cargo test

# 特定のテストのみ実行
cargo test test_validation_error

# テスト出力を表示
cargo test -- --nocapture

# テストカバレッジ（cargo-tarpaulinが必要）
cargo install cargo-tarpaulin
cargo tarpaulin --out Html
```

### 5.2 フロントエンド（TypeScript/React）

```bash
cd frontend

# 全テスト実行
npm run test

# ウォッチモード（ファイル変更時に自動再実行）
npm run test:watch

# カバレッジ付きテスト
npm run test:coverage

# 特定のテストファイルのみ実行
npm run test -- LoadingSpinner

# UIモード（ブラウザでテスト結果を確認）
npm run test:ui
```

### 5.3 Lintチェック

```bash
# バックエンド
cd backend
cargo clippy -- -D warnings    # Lintチェック
cargo fmt                       # フォーマット

# フロントエンド
cd frontend
npx eslint src/                 # Lintチェック
npx eslint src/ --fix           # 自動修正
```

### 5.4 型チェック

```bash
# バックエンド
cd backend
cargo check                     # 高速な型チェック

# フロントエンド
cd frontend
npx tsc --noEmit               # TypeScript型チェック
```

---

## 6. 依存関係

### 6.1 Backend (Cargo.toml)

```toml
[dependencies]
# Web framework
axum = { version = "0.7", features = ["macros", "multipart"] }
tokio = { version = "1", features = ["full"] }
tower = "0.4"
tower-http = { version = "0.5", features = ["cors", "trace"] }
tracing = "0.1"
tracing-subscriber = { version = "0.3", features = ["env-filter"] }

# Serialization
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"

# AWS SDK
aws-sdk-iam = "1"
aws-config = "1"
aws-sdk-sts = "1"

# Azure SDK
azure_identity = "0.30"
azure_core = "0.30"
reqwest = { version = "0.11", features = ["json"] }

# Template engine
minijinja = "1.0"

# Utilities
anyhow = "1.0"
thiserror = "1.0"
uuid = { version = "1.0", features = ["v4", "serde"] }
chrono = { version = "0.4", features = ["serde"] }
zip = "0.6"
futures = "0.3"
lazy_static = "1.4"
```

### 6.2 Frontend (package.json)

```json
{
  "dependencies": {
    "react": "^18.2.0",
    "react-router-dom": "^6.20.0",
    "axios": "^1.6.2",
    "@monaco-editor/react": "^4.6.0"
  }
}
```

---

## 7. デプロイ・配布方法

### 7.1 Tauriビルド＆署名（自動アップデート対応）

TFKosmosは、Tauriを使用してデスクトップアプリケーションとして配布できます。Tauri統合は完了しており、`deployment/src-tauri/`ディレクトリに設定ファイルが含まれています。

#### ビルド形式

- **Windows**: MSI形式で配布
- **macOS**: DMG形式で配布

#### 署名と自動アップデート

- コード署名に対応し、セキュアな配布を実現
- 自動アップデート機能を実装し、ユーザーが最新版を簡単に取得できるようにする

#### ビルド手順

```bash
# Tauri CLIのインストール（グローバル、またはdevDependenciesに含まれています）
npm install -g @tauri-apps/cli

# フロントエンドの依存関係をインストール
cd frontend
npm install

# デスクトップアプリの開発モードで実行
cd ../deployment
npm run dev

# デスクトップアプリのビルド
npm run build

# プラットフォーム別のビルド
# Windows (MSI)
cd src-tauri
cargo tauri build --target x86_64-pc-windows-msvc

# macOS (DMG)
cargo tauri build --target x86_64-apple-darwin
cargo tauri build --target aarch64-apple-darwin
```

**注意**: Tauriアプリを実行すると、バックエンドAPIサーバーも自動的に起動します（`deployment/src-tauri/src/main.rs`で実装）。

#### 署名設定（予定）

- **Windows**: Authenticode署名（コード署名証明書が必要）
- **macOS**: Apple Developer ID証明書を使用した署名

#### 自動アップデート設定（予定）

- Tauriの自動アップデート機能を有効化
- アップデートサーバーの設定
- バージョン管理とリリースプロセスの整備

### 7.2 Tauri環境での設定

#### 開発時

```bash
cd deployment
npm run tauri:dev
```

バックエンドは `http://localhost:8000` で起動し、フロントエンドは Tauri WebView 内で実行されます。

#### ビルド時

```bash
cd deployment
npm run tauri:build
```

ビルドされたアプリは、内部でバックエンドプロセスを起動します。CORS設定は `tauri://localhost` を許可する必要があります。

---

## 8. セキュリティ注意事項

1. **本番環境では必ず `TFKOSMOS_ENV=production` を設定**
   - CORS制限が有効になります
   - デバッグ情報の露出を防ぎます

2. **`TFKOSMOS_HOST=127.0.0.1` を推奨**
   - 外部からの直接アクセスを防ぎます

3. **AWS/Azure認証情報は環境変数に直接設定しない**
   - `~/.aws/credentials` や `az login` を使用してください
   - CI/CD環境では適切なシークレット管理を使用してください

---

## 関連ドキュメント

- [コントリビューションガイド](./コントリビューションガイド.md)
- [コミット戦略](./コミット戦略.md)
- [テスト戦略](../04_品質管理/テスト戦略.md)
- [セキュリティ考慮事項](../04_品質管理/セキュリティ考慮事項.md)
