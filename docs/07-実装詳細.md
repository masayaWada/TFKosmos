# 7. 実装詳細

### 7.1 命名規則の正規化

実装: `src/infra/generators/naming.rs`

実装言語: Rust

主要な機能:

- リソース名の正規化（snake_case, kebab-case, original）

#### NamingGenerator 構造体

```rust
pub struct NamingGenerator;

impl NamingGenerator {
    /// ハイフンとドットをアンダースコアに変換し、小文字化
    pub fn to_snake_case(s: &str) -> String {
        s.replace('-', "_").replace('.', "_").to_lowercase()
    }

    /// アンダースコアとドットをハイフンに変換し、小文字化
    pub fn to_kebab_case(s: &str) -> String {
        s.replace('_', "-").replace('.', "-").to_lowercase()
    }

    /// 命名規則に基づいて変換
    pub fn apply_naming_convention(s: &str, convention: &str) -> String {
        match convention {
            "snake_case" => Self::to_snake_case(s),
            "kebab-case" => Self::to_kebab_case(s),
            "original" => s.to_string(),
            _ => s.to_string(),
        }
    }
}
```

#### 使用例

```rust
// スネークケース変換
assert_eq!(NamingGenerator::to_snake_case("my-resource-name"), "my_resource_name");
assert_eq!(NamingGenerator::to_snake_case("my.resource.name"), "my_resource_name");

// ケバブケース変換
assert_eq!(NamingGenerator::to_kebab_case("my_resource_name"), "my-resource-name");

// 命名規則適用
assert_eq!(NamingGenerator::apply_naming_convention("my-name", "snake_case"), "my_name");
assert_eq!(NamingGenerator::apply_naming_convention("my_name", "kebab-case"), "my-name");
assert_eq!(NamingGenerator::apply_naming_convention("My-Name_Test", "original"), "My-Name_Test");
```

### 7.2 テンプレート例

テンプレートは `minijinja` クレートを使用してレンダリングされます（Jinja2互換）。

#### aws/iam_user.tf.j2

```jinja2
resource "aws_iam_user" "{{ resource_name }}" {
  name = "{{ user.user_name }}"
  path = "{{ user.path }}"
{% if user.tags %}
  tags = {
{% for key, value in user.tags %}
    "{{ key }}" = "{{ value }}"
{% endfor %}
  }
{% endif %}
}
```

#### aws/iam_user_policy_attachment.tf.j2

```jinja2
{% for attachment in attachments %}
resource "aws_iam_user_policy_attachment" "{{ attachment.attachment_id }}" {
  user       = aws_iam_user.{{ attachment.user_resource_name }}.name
  policy_arn = "{{ attachment.policy_arn }}"
}

{% endfor %}
```

#### aws/cleanup_access_key.tf.j2

```jinja2
{% for access_key in access_keys %}
resource "aws_iam_access_key" "ak_{{ access_key.user_resource_name }}_{{ loop.index }}" {
  user = aws_iam_user.{{ access_key.user_resource_name }}.name
}

{% endfor %}
```

### 7.3 importコマンド生成ロジック

実装: `src/infra/generators/terraform.rs`

#### generate_import_command 関数

リソースタイプごとのTerraform importコマンドを生成します。

```rust
use anyhow::Result;
use serde_json::Value;

impl TerraformGenerator {
    /// リソースタイプとプロバイダーに基づいてimportコマンドを生成
    fn generate_import_command(
        resource: &Value,
        resource_type: &str,
        provider: &str,
    ) -> Result<String> {
        let resource_name = Self::get_resource_name(resource, resource_type)?;
        let terraform_resource_name = NamingGenerator::to_snake_case(&resource_name);

        match (provider, resource_type) {
            ("aws", "users") => {
                let arn = resource
                    .get("arn")
                    .and_then(|v| v.as_str())
                    .ok_or_else(|| anyhow::anyhow!("Missing ARN"))?;
                Ok(format!(
                    "terraform import aws_iam_user.{} {}",
                    terraform_resource_name, arn
                ))
            }
            ("aws", "groups") => {
                let arn = resource
                    .get("arn")
                    .and_then(|v| v.as_str())
                    .ok_or_else(|| anyhow::anyhow!("Missing ARN"))?;
                Ok(format!(
                    "terraform import aws_iam_group.{} {}",
                    terraform_resource_name, arn
                ))
            }
            ("aws", "roles") => {
                let arn = resource
                    .get("arn")
                    .and_then(|v| v.as_str())
                    .ok_or_else(|| anyhow::anyhow!("Missing ARN"))?;
                Ok(format!(
                    "terraform import aws_iam_role.{} {}",
                    terraform_resource_name, arn
                ))
            }
            ("aws", "policies") => {
                let arn = resource
                    .get("arn")
                    .and_then(|v| v.as_str())
                    .ok_or_else(|| anyhow::anyhow!("Missing ARN"))?;
                Ok(format!(
                    "terraform import aws_iam_policy.{} {}",
                    terraform_resource_name, arn
                ))
            }
            _ => Err(anyhow::anyhow!(
                "Unsupported provider/resource type combination"
            )),
        }
    }
}
```

#### リソースタイプ別Import ID マッピング

| リソースタイプ | Import ID |
|---------------|-----------|
| `aws_iam_user` | ARN |
| `aws_iam_group` | ARN |
| `aws_iam_role` | ARN |
| `aws_iam_policy` | ARN |
| `aws_iam_user_policy_attachment` | `{user_name}/{policy_arn}` |
| `aws_iam_group_policy_attachment` | `{group_name}/{policy_arn}` |
| `aws_iam_role_policy_attachment` | `{role_name}/{policy_arn}` |
| `aws_iam_group_membership` | `{group_name}` |
| `azure_role_definition` | `{scope}\|{role_definition_id}` |
| `azure_role_assignment` | `{assignment_id}` |

### 7.4 importスクリプト生成

#### Shell Script (import.sh)

```rust
fn generate_sh_import_script(commands: &[String]) -> String {
    let mut script = String::new();
    script.push_str("#!/bin/bash\n");
    script.push_str("# Terraform import script\n");
    script.push_str("# Generated by TFKosmos\n\n");
    script.push_str("set -e\n\n");

    for cmd in commands {
        script.push_str(cmd);
        script.push_str("\n");
    }

    script
}
```

#### PowerShell Script (import.ps1)

```rust
fn generate_ps1_import_script(commands: &[String]) -> String {
    let mut script = String::new();
    script.push_str("# Terraform import script\n");
    script.push_str("# Generated by TFKosmos\n\n");
    script.push_str("$ErrorActionPreference = \"Stop\"\n\n");

    for cmd in commands {
        script.push_str(cmd);
        script.push_str("\n");
    }

    script
}
```

---
