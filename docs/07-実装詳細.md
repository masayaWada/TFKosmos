# 7. 実装詳細

### 7.1 命名規則の正規化

実装: `src/infra/generators/naming.rs`

実装言語: Rust

主要な機能:

- リソース名の正規化（snake_case, kebab-case, original）

主要メソッド:

- `to_snake_case(s: &str) -> String`: スネークケースに変換
- `to_kebab_case(s: &str) -> String`: ケバブケースに変換
- `apply_naming_convention(s: &str, convention: &str) -> String`: 命名規則を適用

実装の特徴:

- 文字列操作（Rust標準ライブラリ）
- パターンマッチングによる命名規則の選択

### 7.2 テンプレート例

#### aws/iam_user.tf.j2

```jinja2
resource "aws_iam_user" "{{ resource_name }}" {
  name = "{{ user.user_name }}"
  path = "{{ user.path }}"
{% if user.tags %}
  tags = {
{% for key, value in user.tags.items() %}
    "{{ key }}" = "{{ value }}"
{% endfor %}
  }
{% endif %}
}
```

#### aws/iam_user_policy_attachment.tf.j2

```jinja2
{% for attachment in attachments %}
resource "aws_iam_user_policy_attachment" "{{ attachment.attachment_id }}" {
  user       = aws_iam_user.{{ attachment.user_resource_name }}.name
  policy_arn = "{{ attachment.policy_arn }}"
}

{% endfor %}
```

#### aws/cleanup_access_key.tf.j2

```jinja2
{% for access_key in access_keys %}
resource "aws_iam_access_key" "ak_{{ access_key.user_resource_name }}_{{ loop.index }}" {
  user = aws_iam_user.{{ access_key.user_resource_name }}.name
}

{% endfor %}
```

### 7.3 importコマンド生成ロジック

```python
def _get_import_id(self, resource_type: str, resource) -> str:
    """リソースタイプごとのimport IDを生成"""
    mapping = {
        "aws_iam_user": lambda r: r.user_name,
        "aws_iam_group": lambda r: r.group_name,
        "aws_iam_role": lambda r: r.role_name,
        "aws_iam_policy": lambda r: r.arn,
        "aws_iam_user_policy_attachment": lambda r: f"{r.user_name}/{r.policy_arn}",
        "aws_iam_group_policy_attachment": lambda r: f"{r.group_name}/{r.policy_arn}",
        "aws_iam_role_policy_attachment": lambda r: f"{r.role_name}/{r.policy_arn}",
        "aws_iam_group_membership": lambda r: f"{r.group_name}/{r.user_name}",
        "aws_cleanup_access_key": lambda r: r.access_key_id,
        "aws_cleanup_login_profile": lambda r: r.user_name,
        "aws_cleanup_mfa": lambda r: f"{r.serial_number}",
        "azure_role_definition": lambda r: f"{r.scope}|{r.role_definition_id}",
        "azure_role_assignment": lambda r: r.assignment_id
    }
    
    func = mapping.get(resource_type)
    if func:
        return func(resource)
    else:
        raise ValueError(f"Unknown resource type: {resource_type}")
```

---

