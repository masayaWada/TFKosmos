# 14. 環境設定

## 14.1 概要

TFKosmosは環境変数を使用してアプリケーションの動作をカスタマイズできます。すべての環境変数は `TFKOSMOS_` プレフィックスで統一されています。

---

## 14.2 環境変数一覧

### バックエンド環境変数

| 変数名 | 説明 | デフォルト値 | 必須 |
|--------|------|-------------|-----|
| `TFKOSMOS_ENV` | 実行環境（`development` / `production`） | `development` | × |
| `TFKOSMOS_HOST` | サーバーがリッスンするホスト | `0.0.0.0` | × |
| `TFKOSMOS_PORT` | サーバーがリッスンするポート | `8000` | × |
| `TFKOSMOS_CORS_ORIGINS` | CORS許可オリジン（カンマ区切り） | 空（開発時は全許可） | × |

### AWS関連（システム環境変数）

| 変数名 | 説明 | 設定方法 |
|--------|------|---------|
| `AWS_PROFILE` | 使用するAWSプロファイル | `~/.aws/credentials`で定義 |
| `AWS_DEFAULT_REGION` | デフォルトリージョン | 通常は`ap-northeast-1`等 |
| `AWS_ACCESS_KEY_ID` | アクセスキーID | 直接指定（非推奨） |
| `AWS_SECRET_ACCESS_KEY` | シークレットアクセスキー | 直接指定（非推奨） |

### Azure関連（システム環境変数）

| 変数名 | 説明 | 設定方法 |
|--------|------|---------|
| `AZURE_TENANT_ID` | AzureテナントID | サービスプリンシパル使用時 |
| `AZURE_CLIENT_ID` | AzureクライアントID | サービスプリンシパル使用時 |
| `AZURE_CLIENT_SECRET` | Azureクライアントシークレット | サービスプリンシパル使用時 |
| `AZURE_SUBSCRIPTION_ID` | AzureサブスクリプションID | スキャン対象指定 |

---

## 14.3 環境変数の詳細

### TFKOSMOS_ENV

実行環境を指定します。環境によってCORS設定やログ出力レベルが変わります。

| 値 | 説明 |
|-----|------|
| `development` | 開発環境。CORS全許可、詳細ログ出力 |
| `production` | 本番環境。CORS制限、最小限のログ出力 |

```bash
# 開発環境（デフォルト）
export TFKOSMOS_ENV=development

# 本番環境
export TFKOSMOS_ENV=production
```

### TFKOSMOS_HOST

サーバーがリッスンするホストアドレスを指定します。

| 値 | 説明 | 用途 |
|-----|------|-----|
| `0.0.0.0` | すべてのネットワークインターフェース | 開発環境、Docker |
| `127.0.0.1` | ローカルホストのみ | 本番環境（セキュリティ強化） |
| `localhost` | ローカルホストのみ | 本番環境 |

```bash
# 外部からのアクセスを許可（開発環境）
export TFKOSMOS_HOST=0.0.0.0

# ローカルのみ許可（本番環境）
export TFKOSMOS_HOST=127.0.0.1
```

### TFKOSMOS_PORT

サーバーがリッスンするポート番号を指定します。

```bash
# デフォルト
export TFKOSMOS_PORT=8000

# カスタムポート
export TFKOSMOS_PORT=3000
```

### TFKOSMOS_CORS_ORIGINS

Cross-Origin Resource Sharing (CORS) で許可するオリジンをカンマ区切りで指定します。

```bash
# 単一オリジン
export TFKOSMOS_CORS_ORIGINS=http://localhost:5173

# 複数オリジン
export TFKOSMOS_CORS_ORIGINS=http://localhost:5173,tauri://localhost,https://myapp.example.com

# 開発環境で空の場合は全オリジン許可
unset TFKOSMOS_CORS_ORIGINS
```

---

## 14.4 開発環境 vs 本番環境

### 開発環境設定

```bash
# .env.development
TFKOSMOS_ENV=development
TFKOSMOS_HOST=0.0.0.0
TFKOSMOS_PORT=8000
# CORS_ORIGINS未設定 = 全オリジン許可
```

**特徴:**
- CORS: すべてのオリジンからのリクエストを許可
- ログ: 詳細なデバッグログを出力
- ホスト: 外部からのアクセスを許可（チーム開発用）

### 本番環境設定

```bash
# .env.production
TFKOSMOS_ENV=production
TFKOSMOS_HOST=127.0.0.1
TFKOSMOS_PORT=8000
TFKOSMOS_CORS_ORIGINS=tauri://localhost
```

**特徴:**
- CORS: 指定されたオリジンのみ許可
- ログ: 最小限のログ出力
- ホスト: ローカルからのアクセスのみ許可

---

## 14.5 設定の適用方法

### 方法1: コマンドライン引数

```bash
# 一時的に環境変数を設定して実行
TFKOSMOS_ENV=production TFKOSMOS_PORT=3000 cargo run
```

### 方法2: シェル設定ファイル

```bash
# ~/.zshrc または ~/.bashrc に追加
export TFKOSMOS_ENV=development
export TFKOSMOS_PORT=8000
```

### 方法3: .envファイル

```bash
# プロジェクトルートに .env ファイルを作成
# 注意: dotenvクレート未導入のため、シェルで読み込む必要があります

# .env ファイルの内容
TFKOSMOS_ENV=development
TFKOSMOS_HOST=0.0.0.0
TFKOSMOS_PORT=8000

# 読み込んで実行
export $(cat .env | xargs) && cd backend && cargo run
```

### 方法4: Makefileタスク

```bash
# Makefileで環境変数を設定
make dev          # 開発環境で起動
make prod         # 本番環境で起動（要追加）
```

---

## 14.6 Tauri環境での設定

Tauriデスクトップアプリとして実行する場合、バックエンドは同梱されます。

### 開発時

```bash
cd deployment
npm run tauri:dev
```

バックエンドは `http://localhost:8000` で起動し、フロントエンドは Tauri WebView 内で実行されます。

### ビルド時

```bash
cd deployment
npm run tauri:build
```

ビルドされたアプリは、内部でバックエンドプロセスを起動します。CORS設定は `tauri://localhost` を許可する必要があります。

---

## 14.7 設定の確認

### バックエンドログで確認

サーバー起動時に設定がログ出力されます：

```
INFO  Environment: Development
INFO  Server listening on 0.0.0.0:8000
INFO  CORS: All origins allowed (development mode)
```

### APIエンドポイントで確認（将来実装予定）

```bash
# 設定確認エンドポイント（開発環境のみ）
curl http://localhost:8000/api/config
```

---

## 14.8 セキュリティ注意事項

1. **本番環境では必ず `TFKOSMOS_ENV=production` を設定**
   - CORS制限が有効になります
   - デバッグ情報の露出を防ぎます

2. **`TFKOSMOS_HOST=127.0.0.1` を推奨**
   - 外部からの直接アクセスを防ぎます

3. **AWS/Azure認証情報は環境変数に直接設定しない**
   - `~/.aws/credentials` や `az login` を使用してください
   - CI/CD環境では適切なシークレット管理を使用してください

---
