# 5. コンポーネント詳細仕様

## バックエンド

### 5.1 Config (src/config.rs)

実装言語: Rust

主要な機能:

- 環境変数からの設定読み込み
- 開発/本番環境の切り替え
- CORS設定の管理

#### Config 構造体

```rust
#[derive(Debug, Clone)]
pub struct Config {
    /// 実行環境（development, production）
    pub environment: Environment,
    /// サーバーがリッスンするホスト
    pub host: String,
    /// サーバーがリッスンするポート
    pub port: u16,
    /// CORS許可オリジン
    pub cors_origins: Vec<String>,
}

#[derive(Debug, Clone, PartialEq)]
pub enum Environment {
    Development,
    Production,
}
```

#### 環境変数

| 変数名 | 説明 | デフォルト値 |
|--------|------|-------------|
| `TFKOSMOS_ENV` | 実行環境（`development` / `production`） | `development` |
| `TFKOSMOS_HOST` | サーバーホスト | `0.0.0.0` |
| `TFKOSMOS_PORT` | サーバーポート | `8000` |
| `TFKOSMOS_CORS_ORIGINS` | CORS許可オリジン（カンマ区切り） | 空（開発環境は全許可） |

#### 主要メソッド

- `from_env() -> Self`: 環境変数から設定を読み込み
- `is_development(&self) -> bool`: 開発環境かどうか
- `is_production(&self) -> bool`: 本番環境かどうか
- `bind_address(&self) -> String`: サーバーのバインドアドレス

### 5.2 ApiError (src/api/error.rs)

実装言語: Rust

主要な機能:

- 統一されたエラーレスポンス形式
- HTTPステータスコードの自動マッピング
- `anyhow::Error`からの自動変換

#### ApiError 列挙型

```rust
pub enum ApiError {
    /// バリデーションエラー（400 Bad Request）
    Validation(String),
    /// 認証エラー（401 Unauthorized）
    Unauthorized(String),
    /// 禁止されたアクセス（403 Forbidden）
    Forbidden(String),
    /// リソースが見つからない（404 Not Found）
    NotFound(String),
    /// 外部サービスエラー（502 Bad Gateway）
    ExternalService { service: String, message: String },
    /// 内部サーバーエラー（500 Internal Server Error）
    Internal(String),
}
```

#### エラーレスポンス形式

```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Invalid input provided",
    "details": { ... }  // オプション
  }
}
```

#### エラーコードマッピング

| ApiError | HTTPステータス | エラーコード |
|----------|---------------|-------------|
| `Validation` | 400 | `VALIDATION_ERROR` |
| `Unauthorized` | 401 | `UNAUTHORIZED` |
| `Forbidden` | 403 | `FORBIDDEN` |
| `NotFound` | 404 | `NOT_FOUND` |
| `ExternalService` | 502 | `EXTERNAL_SERVICE_ERROR` |
| `Internal` | 500 | `INTERNAL_ERROR` |

#### 実装の特徴

- `IntoResponse` トレイトの実装（Axum統合）
- `From<anyhow::Error>` の実装（自動変換）
- エラーメッセージのパターンマッチングによる適切なエラー型選択

### 5.3 Scanner (src/infra/aws/scanner.rs)

#### AwsIamScanner

実装言語: Rust

主要な機能:

- AWS IAMリソースのスキャン（非同期処理）
- AWS SDK for Rustを使用したAPI呼び出し
- フィルタリング機能
- ページネーション対応
- プログレスコールバック

主要メソッド:

- `new(config: ScanConfig) -> Result<Self>`: スキャナーの初期化
- `scan(&self, progress_callback) -> Result<Value>`: 全リソースをスキャン（非同期）
- `scan_users(&self) -> Result<Vec<Value>>`: IAMユーザーをスキャン
- `scan_groups(&self) -> Result<Vec<Value>>`: IAMグループをスキャン
- `scan_roles(&self) -> Result<Vec<Value>>`: IAMロールをスキャン
- `scan_policies(&self) -> Result<Vec<Value>>`: IAMポリシーをスキャン

実装の特徴:

- 非同期処理（Tokioランタイム）
- エラーハンドリング（anyhow::Result）
- JSON形式でのデータ返却（serde_json::Value）
- tracingによるログ出力

### 5.4 TemplateManager (src/infra/templates/manager.rs)

実装言語: Rust

主要な機能:

- テンプレートの読み込み・保存・削除
- デフォルトテンプレートとユーザーテンプレートの管理
- Minijinjaを使用したテンプレートレンダリング

主要メソッド:

- `load_template(template_name: &str) -> Result<String>`: テンプレートを読み込み（ユーザー優先）
- `render_template(template_name: &str, context: &Value) -> Result<String>`: テンプレートをレンダリング

実装の特徴:

- 非同期処理対応
- エラーハンドリング（anyhow::Result）
- Minijinjaテンプレートエンジン（Jinja2互換）

### 5.5 TerraformGenerator (src/infra/generators/terraform.rs)

実装言語: Rust

主要な機能:

- Terraformコードの生成
- importスクリプトの生成
- ファイル分割ルールの適用
- 命名規則の適用

主要メソッド:

- `generate(scan_data, config, selected_resources, output_path) -> Result<Vec<String>>`: Terraformコードを生成
- `generate_import_script(scan_data, config, selected_resources, output_path) -> Result<Option<String>>`: importスクリプトを生成

実装の特徴:

- 非同期処理対応
- エラーハンドリング（anyhow::Result）
- テンプレートエンジン（Minijinja）を使用したコード生成
- ファイル分割ルール（single, by_resource_type, by_resource_name）のサポート

### 5.6 Service Layer

#### ScanService (src/services/scan_service.rs)

実装言語: Rust

主要な機能:

- スキャンの非同期実行
- スキャン結果のキャッシュ管理（メモリ内）
- スキャン状態の管理

主要メソッド:

- `start_scan(config: ScanConfig) -> Result<String>`: スキャンを開始
- `get_scan_result(scan_id: &str) -> Option<ScanResponse>`: スキャン結果を取得
- `get_scan_data(scan_id: &str) -> Option<Value>`: スキャンデータを取得

実装の特徴:

- 非同期処理（Tokio）
- メモリ内キャッシュ（本番環境ではRedis等を推奨）
- UUIDベースのスキャンID管理

#### GenerationService (src/services/generation_service.rs)

実装言語: Rust

主要な機能:

- Terraformコード生成の実行
- ZIPファイルの作成
- 生成結果のキャッシュ管理

主要メソッド:

- `generate_terraform(scan_id, config, selected_resources) -> Result<GenerationResponse>`: Terraformコードを生成
- `create_zip(output_path, generation_id) -> Result<Vec<u8>>`: ZIPファイルを作成

実装の特徴:

- 非同期処理対応
- ZIPファイル生成（zip crate使用）
- エラーハンドリング（anyhow::Result）

---

## フロントエンド

### 5.7 AppContext (src/context/AppContext.tsx)

実装言語: TypeScript/React

主要な機能:

- グローバル状態管理（Context API + useReducer）
- スキャン状態の管理
- 接続状態の管理
- 通知システム

#### 状態の型定義

```typescript
interface AppState {
  scan: ScanState;
  connection: ConnectionState;
  notifications: Notification[];
}

interface ScanState {
  scanId: string | null;
  provider: 'aws' | 'azure' | null;
  status: 'idle' | 'scanning' | 'completed' | 'failed';
  progress: number;
  message: string;
}

interface ConnectionState {
  aws: AwsConnectionState;
  azure: AzureConnectionState;
}

interface Notification {
  id: string;
  type: 'error' | 'success' | 'warning' | 'info';
  message: string;
  duration?: number;
}
```

#### 提供するカスタムフック

| フック | 用途 |
|--------|------|
| `useApp()` | 全状態とアクションへのアクセス |
| `useScan()` | スキャン状態と操作関数 |
| `useConnection()` | 接続状態と操作関数 |
| `useNotifications()` | 通知リストと操作関数 |

#### アクション一覧

**スキャン関連:**
- `START_SCAN`: スキャン開始
- `UPDATE_SCAN_PROGRESS`: 進捗更新
- `COMPLETE_SCAN`: スキャン完了
- `FAIL_SCAN`: スキャン失敗
- `RESET_SCAN`: スキャンリセット

**接続関連:**
- `SET_AWS_CONNECTION` / `SET_AZURE_CONNECTION`: 接続設定更新
- `VALIDATE_AWS_CONNECTION` / `VALIDATE_AZURE_CONNECTION`: 検証成功
- `INVALIDATE_AWS_CONNECTION` / `INVALIDATE_AZURE_CONNECTION`: 検証無効化

**通知関連:**
- `ADD_NOTIFICATION`: 通知追加
- `REMOVE_NOTIFICATION`: 通知削除
- `CLEAR_NOTIFICATIONS`: 全通知クリア

### 5.8 APIクライアント (src/api/client.ts)

実装言語: TypeScript

主要な機能:

- Axiosベースのhttpクライアント
- 統一エラーハンドリング
- タイムアウト設定

#### ApiError クラス

```typescript
class ApiError extends Error {
  code: string;
  details?: unknown;
  status?: number;
  isNetworkError: boolean;
  isTimeout: boolean;
}
```

#### エラー処理

- バックエンドの新形式（`{ error: { code, message, details } }`）をサポート
- レガシー形式（`{ detail: message }`）との後方互換性
- ネットワークエラー/タイムアウトの検出

---
