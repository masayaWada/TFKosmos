# 5. コンポーネント詳細仕様

### 5.1 Scanner (src/infra/aws/scanner.rs)

#### AwsIamScanner

実装言語: Rust

主要な機能:

- AWS IAMリソースのスキャン（非同期処理）
- AWS SDK for Rustを使用したAPI呼び出し
- フィルタリング機能
- ページネーション対応

主要メソッド:

- `new(config: ScanConfig) -> Result<Self>`: スキャナーの初期化
- `scan(&self) -> Result<Value>`: 全リソースをスキャン（非同期）
- `_scan_users(&self) -> Result<Vec<Value>>`: IAMユーザーをスキャン
- `_scan_groups(&self) -> Result<Vec<Value>>`: IAMグループをスキャン
- `_scan_roles(&self) -> Result<Vec<Value>>`: IAMロールをスキャン
- `_scan_policies(&self) -> Result<Vec<Value>>`: IAMポリシーをスキャン
- `_matches_filter(&self, resource_data: &Value) -> bool`: フィルタ条件チェック

実装の特徴:

- 非同期処理（Tokioランタイム）
- エラーハンドリング（anyhow::Result）
- JSON形式でのデータ返却（serde_json::Value）

### 5.2 TemplateManager (src/infra/templates/manager.rs)

実装言語: Rust

主要な機能:

- テンプレートの読み込み・保存・削除
- デフォルトテンプレートとユーザーテンプレートの管理
- Minijinjaを使用したテンプレートレンダリング

主要メソッド:

- `load_template(template_name: &str) -> Result<String>`: テンプレートを読み込み（ユーザー優先）
- `render_template(template_name: &str, context: &Value) -> Result<String>`: テンプレートをレンダリング

実装の特徴:

- 非同期処理対応
- エラーハンドリング（anyhow::Result）
- Minijinjaテンプレートエンジン（Jinja2互換）

### 5.3 TerraformGenerator (src/infra/generators/terraform.rs)

実装言語: Rust

主要な機能:

- Terraformコードの生成
- importスクリプトの生成
- ファイル分割ルールの適用
- 命名規則の適用

主要メソッド:

- `generate(scan_data: &Value, config: &GenerationConfig, selected_resources: &HashMap, output_path: &PathBuf) -> Result<Vec<String>>`: Terraformコードを生成（非同期）
- `generate_import_script(scan_data: &Value, config: &GenerationConfig, selected_resources: &HashMap, output_path: &PathBuf) -> Result<Option<String>>`: importスクリプトを生成（非同期）

実装の特徴:

- 非同期処理対応
- エラーハンドリング（anyhow::Result）
- テンプレートエンジン（Minijinja）を使用したコード生成
- ファイル分割ルール（single, by_resource_type等）のサポート

### 5.4 Service Layer

#### ScanService (src/services/scan_service.rs)

実装言語: Rust

主要な機能:

- スキャンの非同期実行
- スキャン結果のキャッシュ管理（メモリ内）
- スキャン状態の管理

主要メソッド:

- `start_scan(config: ScanConfig) -> Result<String>`: スキャンを開始（非同期、バックグラウンドタスク）
- `get_scan_result(scan_id: &str) -> Option<ScanResponse>`: スキャン結果を取得
- `get_scan_data(scan_id: &str) -> Option<Value>`: スキャンデータを取得

実装の特徴:

- 非同期処理（Tokio）
- メモリ内キャッシュ（本番環境ではRedis等を推奨）
- UUIDベースのスキャンID管理

#### GenerationService (src/services/generation_service.rs)

実装言語: Rust

主要な機能:

- Terraformコード生成の実行
- ZIPファイルの作成
- 生成結果のキャッシュ管理

主要メソッド:

- `generate_terraform(scan_id: &str, config: GenerationConfig, selected_resources: HashMap) -> Result<GenerationResponse>`: Terraformコードを生成（非同期）
- `create_zip(output_path: &str, generation_id: &str) -> Result<Vec<u8>>`: ZIPファイルを作成（非同期）

実装の特徴:

- 非同期処理対応
- ZIPファイル生成（zip crate使用）
- エラーハンドリング（anyhow::Result）

---

