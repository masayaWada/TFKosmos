# 8. エラーハンドリング

## 8.1 バックエンド（Rust）

### ApiError 列挙型

実装: `src/api/error.rs`

統一されたエラーハンドリングを提供する`ApiError` enumを使用します。

```rust
pub enum ApiError {
    /// バリデーションエラー（400 Bad Request）
    Validation(String),
    /// 認証エラー（401 Unauthorized）
    Unauthorized(String),
    /// 禁止されたアクセス（403 Forbidden）
    Forbidden(String),
    /// リソースが見つからない（404 Not Found）
    NotFound(String),
    /// 外部サービスエラー（502 Bad Gateway）
    ExternalService { service: String, message: String },
    /// 内部サーバーエラー（500 Internal Server Error）
    Internal(String),
}
```

### HTTPステータスコードマッピング

| ApiError | HTTPステータス | エラーコード |
|----------|---------------|-------------|
| `Validation(msg)` | 400 Bad Request | `VALIDATION_ERROR` |
| `Unauthorized(msg)` | 401 Unauthorized | `UNAUTHORIZED` |
| `Forbidden(msg)` | 403 Forbidden | `FORBIDDEN` |
| `NotFound(msg)` | 404 Not Found | `NOT_FOUND` |
| `ExternalService { service, message }` | 502 Bad Gateway | `EXTERNAL_SERVICE_ERROR` |
| `Internal(msg)` | 500 Internal Server Error | `INTERNAL_ERROR` |

### エラーレスポンス形式

すべてのAPIエラーは統一されたJSON形式で返されます：

```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Invalid input provided",
    "details": { ... }
  }
}
```

#### ErrorResponse 構造体

```rust
#[derive(Debug, Serialize)]
pub struct ErrorResponse {
    pub error: ErrorDetail,
}

#[derive(Debug, Serialize)]
pub struct ErrorDetail {
    /// エラーコード（クライアント側での処理に使用）
    pub code: String,
    /// 人間が読めるエラーメッセージ
    pub message: String,
    /// 追加の詳細情報（オプション）
    #[serde(skip_serializing_if = "Option::is_none")]
    pub details: Option<serde_json::Value>,
}
```

### anyhow::Error からの自動変換

`anyhow::Error`は自動的に適切な`ApiError`に変換されます：

```rust
impl From<anyhow::Error> for ApiError {
    fn from(err: anyhow::Error) -> Self {
        let message = err.to_string();

        if message.contains("not found") || message.contains("Not found") {
            ApiError::NotFound(message)
        } else if message.contains("validation") || message.contains("invalid") {
            ApiError::Validation(message)
        } else if message.contains("unauthorized") || message.contains("authentication") {
            ApiError::Unauthorized(message)
        } else {
            ApiError::Internal(message)
        }
    }
}
```

### 使用例

```rust
use crate::api::error::ApiError;

async fn get_resource(id: &str) -> Result<Resource, ApiError> {
    let resource = repository.find(id)
        .ok_or_else(|| ApiError::NotFound(format!("Resource {} not found", id)))?;
    Ok(resource)
}

// AWS/Azure API呼び出しでのエラー処理
async fn scan_aws() -> Result<ScanResult, ApiError> {
    aws_client.list_users().await
        .map_err(|e| ApiError::ExternalService {
            service: "AWS".to_string(),
            message: e.to_string(),
        })?;
    // ...
}
```

### 後方互換性

レガシーエラー形式（`{ "detail": "message" }`）もヘルパー関数でサポートされています：

```rust
pub fn legacy_error_response(
    status: StatusCode,
    message: impl Into<String>,
) -> (StatusCode, Json<serde_json::Value>) {
    (status, Json(serde_json::json!({ "detail": message.into() })))
}
```

---

## 8.2 フロントエンド（TypeScript）

### ApiError クラス

実装: `src/api/client.ts`

```typescript
export class ApiError extends Error {
  code: string;
  details?: Record<string, unknown>;
  status: number;

  constructor(
    message: string,
    code: string,
    status: number,
    details?: Record<string, unknown>
  ) {
    super(message);
    this.name = "ApiError";
    this.code = code;
    this.status = status;
    this.details = details;
  }

  /** エラーが外部サービス（AWS/Azure）に起因するかどうか */
  isExternalServiceError(): boolean {
    return this.code === "EXTERNAL_SERVICE_ERROR";
  }

  /** リソースが見つからないエラーかどうか */
  isNotFoundError(): boolean {
    return this.code === "NOT_FOUND";
  }

  /** バリデーションエラーかどうか */
  isValidationError(): boolean {
    return this.code === "VALIDATION_ERROR";
  }
}
```

### エラーコード一覧

| エラーコード | 説明 | 対処方法 |
|-------------|------|---------|
| `VALIDATION_ERROR` | 入力値が不正 | フォームの入力値を確認 |
| `UNAUTHORIZED` | 認証失敗 | 認証情報を再確認 |
| `FORBIDDEN` | アクセス権限不足 | 必要な権限を確認 |
| `NOT_FOUND` | リソースが存在しない | リソースIDを確認 |
| `EXTERNAL_SERVICE_ERROR` | AWS/Azure API エラー | 接続設定や権限を確認 |
| `INTERNAL_ERROR` | サーバー内部エラー | ログを確認、再試行 |
| `NETWORK_ERROR` | ネットワーク接続エラー | バックエンドが起動しているか確認 |
| `TIMEOUT_ERROR` | リクエストタイムアウト | 再試行 |
| `LEGACY_ERROR` | 旧形式のエラー | - |

### Axiosインターセプター

APIクライアントはAxiosインターセプターでエラーを統一的に処理します：

```typescript
apiClient.interceptors.response.use(
  (response) => response,
  (error: AxiosError) => {
    const status = error.response?.status ?? 500;

    if (error.response?.data) {
      const errorData = error.response.data;

      // 新しいエラー形式
      if ("error" in errorData && errorData.error) {
        return Promise.reject(
          new ApiError(
            errorData.error.message,
            errorData.error.code,
            status,
            errorData.error.details
          )
        );
      }

      // レガシー形式（後方互換性）
      if ("detail" in errorData) {
        return Promise.reject(
          new ApiError(errorData.detail, "LEGACY_ERROR", status)
        );
      }
    }

    // ネットワークエラー・タイムアウト等
    // ...
  }
);
```

### エラーハンドリング例

```typescript
import { ApiError, getErrorMessage } from '../api/client';
import { useNotifications } from '../context/AppContext';

function MyComponent() {
  const { addNotification } = useNotifications();

  const handleSubmit = async () => {
    try {
      await apiClient.post('/scan/aws', config);
    } catch (error) {
      if (error instanceof ApiError) {
        if (error.isExternalServiceError()) {
          addNotification('error', `AWS接続エラー: ${error.message}`);
        } else if (error.isValidationError()) {
          addNotification('warning', `入力エラー: ${error.message}`);
        } else {
          addNotification('error', error.message);
        }
      } else {
        addNotification('error', getErrorMessage(error));
      }
    }
  };
}
```

---

## 8.3 エラー分類

### 接続エラー

| エラー | 説明 | 対応 |
|--------|------|------|
| `EXTERNAL_SERVICE_ERROR` (AWS) | AWS APIへの接続失敗 | プロファイル、リージョン、権限を確認 |
| `EXTERNAL_SERVICE_ERROR` (Azure) | Azure APIへの接続失敗 | 認証方式、サブスクリプションを確認 |
| `UNAUTHORIZED` | 認証情報が無効 | 認証情報を再設定 |
| `FORBIDDEN` | 権限不足 | IAMポリシーを確認 |

### スキャンエラー

| エラー | 説明 | 対応 |
|--------|------|------|
| `NOT_FOUND` | スキャンIDが存在しない | スキャンを再実行 |
| `VALIDATION_ERROR` | スキャン設定が不正 | フィルタ条件を確認 |
| Rate Limit | API呼び出し制限 | 自動リトライ（指数バックオフ） |

### 生成エラー

| エラー | 説明 | 対応 |
|--------|------|------|
| `NOT_FOUND` | テンプレートが見つからない | テンプレートの存在を確認 |
| `VALIDATION_ERROR` | 生成設定が不正 | 設定値を確認 |
| `INTERNAL_ERROR` | テンプレートレンダリング失敗 | テンプレート構文を確認 |

---

## 8.4 リトライ戦略

一時的なエラー（Rate Limit、ネットワーク断等）に対しては自動リトライを実装：

- **最大リトライ回数**: 3回
- **バックオフ戦略**: 指数バックオフ（1秒、2秒、4秒）
- **リトライ対象**:
  - ネットワークエラー
  - Rate Limit エラー（429）
  - 一時的なサーバーエラー（503）

---
