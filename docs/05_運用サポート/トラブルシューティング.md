# 15. トラブルシューティング

## 15.1 開発環境の問題

### cargoコマンドが見つからない

**症状:**
```
zsh: command not found: cargo
```

**原因:**
Rustのパスが設定されていません。

**解決策:**

```bash
# 方法1: 現在のセッションでパスを読み込む
source ~/.cargo/env

# 方法2: シェル設定ファイルに追加（永続化）
echo 'source "$HOME/.cargo/env"' >> ~/.zshrc
# または
echo 'source "$HOME/.cargo/env"' >> ~/.bashrc

# シェルを再読み込み
source ~/.zshrc
```

Rustがインストールされていない場合：
```bash
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
```

---

### npm/nodeコマンドが見つからない

**症状:**
```
zsh: command not found: npm
```

**解決策:**

```bash
# Node.jsをインストール（Homebrew使用）
brew install node

# または nvm を使用（推奨）
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.zshrc
nvm install --lts
nvm use --lts
```

---

### フロントエンドの依存関係エラー

**症状:**
```
npm ERR! code ERESOLVE
npm ERR! ERESOLVE unable to resolve dependency tree
```

**解決策:**

```bash
cd frontend

# node_modulesを削除して再インストール
rm -rf node_modules package-lock.json
npm install

# それでも解決しない場合
npm install --legacy-peer-deps
```

---

### バックエンドのビルドエラー

**症状:**
```
error[E0433]: failed to resolve: use of undeclared crate or module
```

**解決策:**

```bash
cd backend

# キャッシュをクリアして再ビルド
cargo clean
cargo build

# Cargo.lockを再生成
rm Cargo.lock
cargo build
```

---

## 15.2 接続・ネットワークの問題

### CORS関連のエラー

**症状:**
ブラウザコンソールに以下のエラーが表示される：
```
Access to XMLHttpRequest at 'http://localhost:8000/api/...' from origin 'http://localhost:5173'
has been blocked by CORS policy
```

**原因:**
バックエンドのCORS設定が不足しています。

**解決策:**

```bash
# 開発環境の場合（全オリジン許可）
TFKOSMOS_ENV=development cargo run

# または明示的にオリジンを指定
TFKOSMOS_CORS_ORIGINS=http://localhost:5173 cargo run
```

---

### バックエンドに接続できない

**症状:**
```
バックエンドサーバーに接続できません。サーバーが起動しているか確認してください。
```

**確認事項:**

1. バックエンドが起動しているか確認：
```bash
# プロセス確認
lsof -i :8000

# または
curl http://localhost:8000/api/health
```

2. バックエンドを起動：
```bash
cd backend
cargo run
```

3. ポートが使用中の場合：
```bash
# ポートを使用しているプロセスを終了
kill $(lsof -t -i:8000)

# または別のポートで起動
TFKOSMOS_PORT=3000 cargo run
```

---

### プロキシエラー（Vite開発サーバー）

**症状:**
```
[vite] http proxy error
```

**解決策:**

`vite.config.ts` のプロキシ設定を確認：

```typescript
export default defineConfig({
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:8000',
        changeOrigin: true,
      },
    },
  },
});
```

---

## 15.3 AWS認証エラー

### 認証情報が見つからない

**症状:**
```
Error: No credentials in the environment or credentials file
```

**解決策:**

```bash
# AWS CLIで認証情報を設定
aws configure

# または環境変数で設定（非推奨）
export AWS_ACCESS_KEY_ID=your_access_key
export AWS_SECRET_ACCESS_KEY=your_secret_key
export AWS_DEFAULT_REGION=ap-northeast-1
```

---

### プロファイルが見つからない

**症状:**
```
Error: Profile 'xxx' not found in credentials file
```

**解決策:**

```bash
# 利用可能なプロファイルを確認
cat ~/.aws/credentials

# プロファイルを追加
aws configure --profile myprofile
```

---

### アクセス拒否エラー

**症状:**
```
Error: AccessDenied - User is not authorized to perform iam:ListUsers
```

**解決策:**

使用しているIAMユーザー/ロールに以下のポリシーをアタッチ：

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "iam:ListUsers",
        "iam:ListGroups",
        "iam:ListRoles",
        "iam:ListPolicies",
        "iam:GetUser",
        "iam:GetGroup",
        "iam:GetRole",
        "iam:GetPolicy",
        "iam:GetPolicyVersion",
        "iam:ListAttachedUserPolicies",
        "iam:ListAttachedGroupPolicies",
        "iam:ListAttachedRolePolicies",
        "iam:ListGroupsForUser",
        "iam:ListUserTags",
        "iam:ListRoleTags",
        "iam:ListMFADevices",
        "iam:ListAccessKeys"
      ],
      "Resource": "*"
    }
  ]
}
```

---

### AssumeRoleエラー

**症状:**
```
Error: AccessDenied when calling the AssumeRole operation
```

**解決策:**

1. 信頼ポリシーを確認（ターゲットロール側）：
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::SOURCE_ACCOUNT:user/your-user"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
```

2. AssumeRole権限を確認（ソースユーザー側）：
```json
{
  "Effect": "Allow",
  "Action": "sts:AssumeRole",
  "Resource": "arn:aws:iam::TARGET_ACCOUNT:role/target-role"
}
```

---

## 15.4 Azure認証エラー

### Azure CLIでログインしていない

**症状:**
```
Error: Azure CLI is not logged in
```

**解決策:**

```bash
# Azure CLIでログイン
az login

# ログイン状態を確認
az account show
```

---

### サブスクリプションが見つからない

**症状:**
```
Error: Subscription 'xxx' not found
```

**解決策:**

```bash
# 利用可能なサブスクリプションを確認
az account list --output table

# サブスクリプションを設定
az account set --subscription "your-subscription-id"
```

---

### サービスプリンシパル認証エラー

**症状:**
```
Error: AADSTS7000215: Invalid client secret provided
```

**解決策:**

1. 環境変数を確認：
```bash
echo $AZURE_TENANT_ID
echo $AZURE_CLIENT_ID
echo $AZURE_CLIENT_SECRET
```

2. シークレットの有効期限を確認（Azure Portal）

3. 新しいシークレットを生成して設定

---

## 15.5 Terraformコード生成の問題

### テンプレートエラー

**症状:**
```
Error: Template rendering failed
```

**解決策:**

1. テンプレート構文を確認：
```bash
# デフォルトテンプレートを確認
cat backend/templates_default/terraform/aws/iam_user.tf.j2
```

2. ユーザーテンプレートをリセット：
```bash
# ユーザーテンプレートを削除（デフォルトに戻る）
rm -rf backend/templates_user/
```

---

### 出力ディレクトリの権限エラー

**症状:**
```
Error: Permission denied when writing to output directory
```

**解決策:**

```bash
# 出力ディレクトリの権限を確認
ls -la backend/terraform-output/

# 権限を修正
chmod -R 755 backend/terraform-output/
```

---

## 15.6 Tauriアプリの問題

### Tauriビルドエラー

**症状:**
```
Error: failed to bundle project
```

**解決策:**

```bash
cd deployment

# 依存関係を再インストール
rm -rf node_modules
npm install

# Tauriの依存関係を確認
cd src-tauri
cargo check
```

---

### アプリが起動しない

**症状:**
アプリが起動後すぐに終了する

**解決策:**

1. ログを確認：
```bash
# macOS
tail -f ~/Library/Logs/TFKosmos/main.log

# Windows
type %APPDATA%\TFKosmos\logs\main.log
```

2. 開発モードで実行してエラーを確認：
```bash
cd deployment
npm run tauri:dev
```

---

## 15.7 よくある質問

### Q: スキャン結果はどこに保存されますか？

**A:** スキャン結果はメモリ内に一時保存され、セッション終了時に破棄されます。永続化が必要な場合は、生成されたTerraformコードをダウンロードしてください。

### Q: 生成されたファイルはどこに保存されますか？

**A:** `backend/terraform-output/{generation_id}/` ディレクトリに保存されます。

### Q: 複数のAWSアカウントをスキャンできますか？

**A:** 現在は1回のスキャンで1アカウントのみ対応しています。複数アカウントをスキャンする場合は、プロファイルを切り替えて再スキャンしてください。

---
