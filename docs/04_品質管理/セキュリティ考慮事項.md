# 9. セキュリティ考慮事項

## 9.1 認証情報の扱い

### 基本方針

- **メモリ上のみ保持**: 認証情報はメモリ上でのみ扱い、永続化しない
- **ログ出力禁止**: 認証情報をログに出力しない
- **設定ファイル保存禁止**: 認証情報を設定ファイルに保存しない

### AWS認証

AWS SDKのデフォルト認証チェーンを使用：

1. 環境変数（`AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`）
2. AWS認証情報ファイル（`~/.aws/credentials`）
3. EC2インスタンスプロファイル / ECSタスクロール

```rust
// AWS SDK for Rustの認証チェーン
let config = aws_config::defaults(aws_config::BehaviorVersion::latest())
    .profile_name(profile)
    .load()
    .await;
```

### Azure認証

Azure SDK for Rustの認証チェーンを使用：

1. 環境変数
2. Azure CLI認証（`az login`）
3. サービスプリンシパル

---

## 9.2 機密情報の除外

### スキャン時に取得しない情報

| リソース | 除外する情報 |
|---------|-------------|
| IAMユーザー | アクセスキーシークレット、パスワード |
| IAMロール | 信頼ポリシー内の機密情報 |
| MFAデバイス | MFAシード、OTPシークレット |
| サービスプリンシパル | クライアントシークレット |

### 生成コードへの機密情報混入防止

```rust
// 例: ポリシードキュメント内の機密情報をマスク
fn sanitize_policy_document(policy: &str) -> String {
    // AWS_SECRET_ACCESS_KEYパターンをマスク
    // パスワードパターンをマスク
    // ...
}
```

---

## 9.3 ローカル実行

### データフローの局所化

```
[AWS/Azure API] <--認証--> [ローカルバックエンド] <--API--> [ローカルフロントエンド]
                                    |
                                    v
                          [ローカルファイルシステム]
                           (terraform-output/)
```

- すべての処理はローカルマシン上で実行
- 外部サーバーへのデータ送信なし
- 生成されたTerraformコードはローカルに保存

### ネットワーク通信

| 通信先 | 目的 | 必須 |
|-------|------|-----|
| AWS API | IAMリソーススキャン | AWS使用時 |
| Azure API | IAMリソーススキャン | Azure使用時 |
| localhost | フロントエンド ↔ バックエンド通信 | 常時 |

---

## 9.4 環境変数による設定管理

### 環境変数一覧

| 変数名 | 説明 | デフォルト | 本番推奨 |
|--------|------|-----------|---------|
| `TFKOSMOS_ENV` | 実行環境 | `development` | `production` |
| `TFKOSMOS_HOST` | サーバーホスト | `0.0.0.0` | `127.0.0.1` |
| `TFKOSMOS_PORT` | サーバーポート | `8000` | `8000` |
| `TFKOSMOS_CORS_ORIGINS` | CORS許可オリジン | 全許可（開発時） | 特定オリジンのみ |

### 環境別設定

#### 開発環境 (`TFKOSMOS_ENV=development`)

```bash
# 全オリジンからのCORSを許可（開発の利便性のため）
TFKOSMOS_ENV=development
TFKOSMOS_HOST=0.0.0.0
TFKOSMOS_PORT=8000
```

#### 本番環境 (`TFKOSMOS_ENV=production`)

```bash
# CORSを特定オリジンに制限
TFKOSMOS_ENV=production
TFKOSMOS_HOST=127.0.0.1
TFKOSMOS_PORT=8000
TFKOSMOS_CORS_ORIGINS=http://localhost:5173,tauri://localhost
```

---

## 9.5 CORS設定

### 開発環境

開発環境では利便性のため全オリジンを許可：

```rust
if config.is_development() {
    cors = cors.allow_any_origin();
}
```

### 本番環境

本番環境では`TFKOSMOS_CORS_ORIGINS`で指定されたオリジンのみ許可：

```rust
if !config.cors_origins.is_empty() {
    for origin in &config.cors_origins {
        cors = cors.allow_origin(origin.parse::<HeaderValue>()?);
    }
}
```

### Tauri統合

Tauriアプリからのリクエストは`tauri://localhost`オリジンを使用するため、本番環境でも許可が必要：

```bash
TFKOSMOS_CORS_ORIGINS=tauri://localhost
```

---

## 9.6 入力バリデーション

### バックエンド

#### リクエストバリデーション

```rust
#[derive(Debug, Deserialize, Validate)]
pub struct ScanConfig {
    #[validate(length(min = 1))]
    pub provider: String,

    #[validate(custom = "validate_profile_name")]
    pub profile: Option<String>,

    // ...
}
```

#### パストラバーサル防止

```rust
fn validate_output_path(path: &str) -> Result<PathBuf, ApiError> {
    let path = PathBuf::from(path);

    // 絶対パスを禁止（オプション）
    if path.is_absolute() {
        return Err(ApiError::Validation("Absolute paths not allowed".into()));
    }

    // ".." を含むパスを禁止
    if path.components().any(|c| c == std::path::Component::ParentDir) {
        return Err(ApiError::Validation("Path traversal not allowed".into()));
    }

    Ok(path)
}
```

### フロントエンド

#### フォームバリデーション

- 必須フィールドのチェック
- 文字列長の制限
- 許可された値のみ受け入れ（enum）

```typescript
const validateScanConfig = (config: ScanConfig): string[] => {
  const errors: string[] = [];

  if (!config.provider) {
    errors.push('プロバイダーを選択してください');
  }

  if (config.provider === 'aws' && !config.profile) {
    errors.push('AWSプロファイルを選択してください');
  }

  return errors;
};
```

---

## 9.7 依存関係のセキュリティ

### Rust依存関係

```bash
# 脆弱性スキャン
cargo audit

# 依存関係の更新
cargo update
```

### JavaScript依存関係

```bash
# 脆弱性スキャン
npm audit

# 脆弱性の自動修正
npm audit fix

# 依存関係の更新
npm update
```

### 推奨事項

- 定期的な依存関係の更新（週次/月次）
- CI/CDパイプラインでの自動脆弱性スキャン
- 重大な脆弱性は即座に対応

---

## 9.8 セキュリティチェックリスト

### 開発時

- [ ] 認証情報をコードにハードコードしていない
- [ ] ログに機密情報を出力していない
- [ ] ユーザー入力をすべてバリデートしている
- [ ] パストラバーサル攻撃を防いでいる

### デプロイ時

- [ ] `TFKOSMOS_ENV=production`を設定
- [ ] CORS設定を適切に制限
- [ ] 不要なポートを閉じている
- [ ] 依存関係の脆弱性スキャンを実施

### 運用時

- [ ] 定期的な依存関係の更新
- [ ] セキュリティアップデートの適用
- [ ] アクセスログの監視

---
