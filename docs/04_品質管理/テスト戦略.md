# 11. テスト戦略

## 11.1 バックエンド（Rust）

### テストフレームワーク

Rust標準のテストフレームワークを使用：

```bash
# 全テスト実行
cargo test

# 特定のテストのみ実行
cargo test test_validation_error

# テスト出力を表示
cargo test -- --nocapture
```

### 単体テスト

#### テスト対象

| モジュール | テスト内容 |
|-----------|----------|
| `api/error.rs` | ApiErrorのステータスコード、エラーコード、メッセージ変換 |
| `config.rs` | 環境変数読み込み、デフォルト値、環境判定 |
| `infra/generators/naming.rs` | 命名規則変換（snake_case, kebab-case） |
| `infra/generators/terraform.rs` | Terraformコード生成、importスクリプト生成 |
| `infra/templates/manager.rs` | テンプレート読み込み、レンダリング |

#### テスト例（config.rs）

```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_default_config() {
        let config = Config::default();
        assert_eq!(config.environment, Environment::Development);
        assert_eq!(config.host, "0.0.0.0");
        assert_eq!(config.port, 8000);
        assert!(config.cors_origins.is_empty());
    }

    #[test]
    fn test_is_development() {
        let config = Config {
            environment: Environment::Development,
            ..Default::default()
        };
        assert!(config.is_development());
        assert!(!config.is_production());
    }

    #[test]
    fn test_bind_address() {
        let config = Config {
            host: "127.0.0.1".to_string(),
            port: 3000,
            ..Default::default()
        };
        assert_eq!(config.bind_address(), "127.0.0.1:3000");
    }
}
```

#### テスト例（error.rs）

```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_validation_error_status_code() {
        let error = ApiError::Validation("Invalid input".to_string());
        assert_eq!(error.status_code(), StatusCode::BAD_REQUEST);
        assert_eq!(error.code(), "VALIDATION_ERROR");
    }

    #[test]
    fn test_external_service_error_has_details() {
        let error = ApiError::ExternalService {
            service: "AWS".to_string(),
            message: "Connection failed".to_string(),
        };
        assert_eq!(error.status_code(), StatusCode::BAD_GATEWAY);
        assert!(error.details().is_some());
    }

    #[test]
    fn test_anyhow_error_conversion_not_found() {
        let err = anyhow::anyhow!("Resource not found");
        let api_error: ApiError = err.into();
        assert!(matches!(api_error, ApiError::NotFound(_)));
    }
}
```

### 統合テスト

#### API統合テスト

Axumのテストユーティリティを使用：

```rust
#[cfg(test)]
mod integration_tests {
    use axum::http::StatusCode;
    use axum_test::TestServer;

    #[tokio::test]
    async fn test_health_check() {
        let app = create_app();
        let server = TestServer::new(app).unwrap();

        let response = server.get("/api/health").await;
        assert_eq!(response.status_code(), StatusCode::OK);
    }

    #[tokio::test]
    async fn test_scan_validation_error() {
        let app = create_app();
        let server = TestServer::new(app).unwrap();

        let response = server
            .post("/api/scan/aws")
            .json(&serde_json::json!({}))
            .await;

        assert_eq!(response.status_code(), StatusCode::BAD_REQUEST);
    }
}
```

### モック

#### AWS/Azure APIモック

テスト時は実際のAPI呼び出しをモック化：

```rust
#[cfg(test)]
mod tests {
    use mockall::predicate::*;

    #[tokio::test]
    async fn test_scan_with_mock_aws() {
        let mut mock_client = MockAwsIamClient::new();
        mock_client
            .expect_list_users()
            .returning(|| Ok(vec![/* mock data */]));

        let scanner = AwsIamScanner::new_with_client(mock_client);
        let result = scanner.scan_users().await;
        assert!(result.is_ok());
    }
}
```

---

## 11.2 フロントエンド（TypeScript/React）

### テストフレームワーク

**Vitest** + **React Testing Library** を使用：

```bash
# テスト実行
npm run test

# ウォッチモード
npm run test:watch

# カバレッジ付き
npm run test:coverage
```

### Vitest設定

`vitest.config.ts`:

```typescript
import { defineConfig } from 'vitest/config';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: ['./src/test/setup.ts'],
    include: ['src/**/*.{test,spec}.{ts,tsx}'],
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: [
        'node_modules/',
        'src/test/',
        '**/*.d.ts',
      ],
    },
  },
});
```

### テストセットアップ

`src/test/setup.ts`:

```typescript
import '@testing-library/jest-dom';
import { cleanup } from '@testing-library/react';
import { afterEach } from 'vitest';

// 各テスト後にクリーンアップ
afterEach(() => {
  cleanup();
});

// localStorageのモック
const localStorageMock = (() => {
  let store: Record<string, string> = {};
  return {
    getItem: (key: string) => store[key] || null,
    setItem: (key: string, value: string) => {
      store[key] = value;
    },
    removeItem: (key: string) => {
      delete store[key];
    },
    clear: () => {
      store = {};
    },
  };
})();

Object.defineProperty(window, 'localStorage', {
  value: localStorageMock,
});
```

### カスタムレンダラー

`src/test/utils.tsx`:

```typescript
import { ReactElement } from 'react';
import { render, RenderOptions } from '@testing-library/react';
import { BrowserRouter } from 'react-router-dom';

// カスタムレンダラー（Router付き）
function customRender(
  ui: ReactElement,
  options?: Omit<RenderOptions, 'wrapper'>,
) {
  return render(ui, {
    wrapper: ({ children }) => <BrowserRouter>{children}</BrowserRouter>,
    ...options,
  });
}

// re-export everything
export * from '@testing-library/react';
export { customRender as render };
```

### 実装済みテスト一覧

| コンポーネント | テストファイル | テスト内容 |
|--------------|---------------|----------|
| `LoadingSpinner` | `LoadingSpinner.test.tsx` | スピナー表示、メッセージ表示 |
| `ErrorMessage` | `ErrorMessage.test.tsx` | エラーメッセージ表示、スタイリング |
| `SuccessMessage` | `SuccessMessage.test.tsx` | 成功メッセージ表示 |
| `ScanTargetSelector` | `ScanTargetSelector.test.tsx` | チェックボックス選択、全選択/解除 |
| `ScanProgressBar` | `ScanProgressBar.test.tsx` | 進捗表示、ステータスメッセージ |

### テスト例

#### LoadingSpinner.test.tsx

```typescript
import { describe, it, expect } from 'vitest';
import { render, screen } from '../test/utils';
import LoadingSpinner from './LoadingSpinner';

describe('LoadingSpinner', () => {
  it('renders spinner without message', () => {
    render(<LoadingSpinner />);
    expect(screen.getByRole('status')).toBeInTheDocument();
  });

  it('renders spinner with message', () => {
    render(<LoadingSpinner message="Loading..." />);
    expect(screen.getByText('Loading...')).toBeInTheDocument();
  });
});
```

#### ScanTargetSelector.test.tsx

```typescript
import { describe, it, expect, vi } from 'vitest';
import { render, screen, fireEvent } from '../test/utils';
import ScanTargetSelector from './ScanTargetSelector';

describe('ScanTargetSelector', () => {
  const mockTargets = {
    users: true,
    groups: false,
    roles: true,
  };

  it('renders all checkboxes', () => {
    render(
      <ScanTargetSelector
        provider="aws"
        targets={mockTargets}
        onChange={vi.fn()}
      />
    );

    expect(screen.getByLabelText('Users')).toBeChecked();
    expect(screen.getByLabelText('Groups')).not.toBeChecked();
    expect(screen.getByLabelText('Roles')).toBeChecked();
  });

  it('calls onChange when checkbox clicked', () => {
    const handleChange = vi.fn();
    render(
      <ScanTargetSelector
        provider="aws"
        targets={mockTargets}
        onChange={handleChange}
      />
    );

    fireEvent.click(screen.getByLabelText('Groups'));
    expect(handleChange).toHaveBeenCalledWith({ ...mockTargets, groups: true });
  });
});
```

---

## 11.3 テスト規約

### ファイル配置

テストファイルは対象ファイルと同じディレクトリに配置：

```
src/components/common/
├── LoadingSpinner.tsx
├── LoadingSpinner.test.tsx  # テストファイル
├── ErrorMessage.tsx
└── ErrorMessage.test.tsx    # テストファイル
```

### 命名規則

- **テストファイル**: `{ComponentName}.test.tsx` または `{module_name}_test.rs`
- **テスト関数**: `test_{機能}_{条件}_{期待結果}` 形式を推奨

```rust
#[test]
fn test_validation_error_returns_bad_request() { ... }

#[test]
fn test_not_found_error_contains_message() { ... }
```

### テストの原則

1. **意味のあるアサーション**: `expect(true).toBe(true)` のような無意味なテストは禁止
2. **実際の動作検証**: 入力と期待される出力を明確に検証
3. **境界値テスト**: エッジケース、異常系を含める
4. **独立性**: 各テストは他のテストに依存しない

---

## 11.4 CI/CD統合

### GitHub Actions設定例

```yaml
name: Test

on: [push, pull_request]

jobs:
  backend-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - run: cd backend && cargo test

  frontend-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: cd frontend && npm ci
      - run: cd frontend && npm run test
```

---

## 11.5 カバレッジ目標

| 領域 | 目標カバレッジ |
|------|--------------|
| バックエンドAPI | 80% |
| バックエンドサービス層 | 70% |
| フロントエンドコンポーネント | 70% |
| フロントエンドユーティリティ | 90% |

---
